# Leaderboard "No Closed Cases" Fix - Summary

## Problem
The leaderboard was showing "No closed cases" despite users showing evidence of cases being created and assigned to the "Incident and Case Management" group (e.g., SCS0050818-SCS0050895 created on 2025-11-15).

## Root Cause
The `buildFlexibleLikeQuery()` function in `/lib/infrastructure/servicenow/repositories/query-builders.ts` was generating complex LIKE queries for assignment group filtering:

```
(assignment_group.nameLIKEIncident and Case Management^ORassignment_group.nameLIKEIncidentandCaseManagement^OR(assignment_group.nameLIKEIncident^assignment_group.nameLIKEand^assignment_group.nameLIKECase^assignment_group.nameLIKEManagement))
```

This complex query triggered a **403 Forbidden** error from ServiceNow API:
```json
{
  "error": {
    "message": "Insufficient rights to query records",
    "detail": "Field(s) present in the query do not have permission to be read"
  }
}
```

The API service account (`SVC.Mobiz.Integration.TableAPI.PROD`) has permission to read the assignment group field but NOT to execute LIKE queries on it.

## Investigation Process

### 1. Environment Setup Issue
Initial tests failed because environment variables were loaded AFTER the ServiceNow client was instantiated. Created test scripts that properly load `.env.local` before importing services.

### 2. Direct API Testing
Used direct `fetch()` calls to test different query formats:

| Query Type | Result |
|------------|--------|
| Simple fetch (no filters) | ✅ 200 OK - 5 cases |
| Assignment group by sys_id | ✅ 200 OK - 50 cases |
| Exact name match (`=`) | ✅ 200 OK - 50 cases |
| LIKE query (generated by code) | ❌ 403 Forbidden |

### 3. Root Cause Identified
The LIKE query permissions issue was discovered by comparing what works vs. what fails.

## The Fix

**File:** `/lib/infrastructure/servicenow/repositories/case-repository.impl.ts`

**Changed** (line 168-174):
```typescript
if (criteria.assignmentGroup) {
  // Assignment group by display name
  const clause = buildFlexibleLikeQuery("assignment_group.name", criteria.assignmentGroup);
  if (clause) {
    queryParts.push(clause);
  }
}
```

**To:**
```typescript
if (criteria.assignmentGroup) {
  // Assignment group by display name - use exact match to avoid permissions issues with LIKE
  queryParts.push(`assignment_group.name=${criteria.assignmentGroup}`);
}
```

## Test Results

### Before Fix
```
[Leaderboard] Fetched page 0 for group "Incident and Case Management": 0 cases (total: 0)
[Leaderboard] Retrieved 0 ServiceNow cases for aggregation.
[Leaderboard] Collected 0 rows: []
```

### After Fix
```
[Leaderboard] Fetched page 0 for group "Incident and Case Management": 50 cases (total: 50)
[Leaderboard] Fetched page 0 for group "Network Engineers": 8 cases (total: 58)
[Leaderboard] Retrieved 58 ServiceNow cases for aggregation.
[Leaderboard] Collected 11 rows: [
  {
    "name": "Junaid Hyder",
    "email": null,
    "assigned": 12,
    "resolved": 5,
    "active": 12,
    "avgResolutionMinutes": 239.39666666666668
  },
  {
    "name": "Umar Ahmed",
    "email": null,
    "assigned": 12,
    "resolved": 0,
    "active": 12,
    "avgResolutionMinutes": null
  },
  {
    "name": "Ahmed Syed",
    "email": null,
    "assigned": 9,
    "resolved": 0,
    "active": 10,
    "avgResolutionMinutes": null
  },
  ...
]
```

## Impact & Limitations

### Positive Impact
✅ Leaderboard now successfully fetches and aggregates cases
✅ No more 403 permission errors
✅ Correctly shows case statistics for all team members

### Limitations
⚠️ Assignment group names must now match **exactly** (case-sensitive)
⚠️ Previous flexible matching that tolerated variations is no longer available

This trade-off is acceptable because:
1. Assignment group names are controlled values in ServiceNow
2. The leaderboard configuration uses exact group names
3. Exact matching is more predictable and performant

## Test Scripts Created

Several diagnostic scripts were created in `/scripts/`:
- `test-leaderboard-local.ts` - End-to-end leaderboard test with proper env loading
- `test-servicenow-direct.ts` - Direct API calls to verify credentials and permissions
- `test-assignment-group-query.ts` - Compare different query formats (sys_id, exact, LIKE)

These can be used for future debugging:
```bash
npx tsx scripts/test-leaderboard-local.ts
npx tsx scripts/test-servicenow-direct.ts
npx tsx scripts/test-assignment-group-query.ts
```

## Deployment Notes

This fix is committed to the `staging` branch and ready for deployment. The change is backward-compatible - existing leaderboard configurations using exact assignment group names will continue to work (and now actually return data instead of failing silently).

## Key Takeaway

When ServiceNow queries return 0 results unexpectedly:
1. Check for **403/401 errors** in ServiceNow HTTP client logs
2. Test with **direct API calls** using different query formats
3. Verify **API user permissions** - some fields may be readable but not queryable with LIKE
4. Use **exact match** operators when possible to minimize permission requirements
