exports.id=214,exports.ids=[214],exports.modules={57943:()=>{},39045:(e,t,s)=>{"use strict";function n(e,t){let s=process.env[e];return s?function({value:e,defaultValue:t,raw:s,envKey:n}){return Number.isFinite(e)&&e>0?e:(void 0!==s&&console.warn(`[Config] Ignoring invalid value for ${n}: ${s}. Using default ${t}.`),t)}({value:Number(s),defaultValue:t,raw:s,envKey:e}):t}function a(e,t){let s=process.env[e];return s?"true"===s.toLowerCase()||"1"===s:t}s.d(t,{v:()=>o});let o={kbGatheringTimeoutHours:n("KB_GATHERING_TIMEOUT_HOURS",24),kbGatheringMaxAttempts:n("KB_GATHERING_MAX_ATTEMPTS",5),assistantMinDescriptionLength:n("ASSISTANT_MIN_DESCRIPTION_LENGTH",10),assistantSimilarCasesTopK:n("ASSISTANT_SIMILAR_CASES_TOP_K",3),kbSimilarCasesTopK:n("KB_SIMILAR_CASES_TOP_K",3),assistantActiveStates:function(e,t){let s=process.env[e];return s&&""!==s.trim()?s.split(",").map(e=>e.trim()).filter(e=>e.length>0):t}("ASSISTANT_ACTIVE_STATES",["New","In Progress","On Hold","Pending","Awaiting Info","Work in Progress"]),proactiveTroubleshootingEnabled:a("PROACTIVE_TROUBLESHOOTING_ENABLED",!0),autoCmdbLookupEnabled:a("AUTO_CMDB_LOOKUP_ENABLED",!0),maxClarifyingQuestions:n("MAX_CLARIFYING_QUESTIONS",4)}},7047:(e,t,s)=>{"use strict";s.d(t,{c:()=>u});var n=s(30513),a=s(61023),o=s(51921),r=s(19954);class i{async saveContext(e){let t=(0,o.zA)();if(t)try{await t.insert(r.caseContexts).values({caseNumber:e.caseNumber,threadTs:e.threadTs,channelId:e.channelId,channelName:e.channelName,isResolved:e.isResolved||!1,resolvedAt:e.resolvedAt,detectedAt:e.detectedAt,lastUpdated:e.lastUpdated,notified:e._notified||!1}).onConflictDoUpdate({target:[r.caseContexts.caseNumber,r.caseContexts.threadTs],set:{channelName:e.channelName,isResolved:e.isResolved||!1,resolvedAt:e.resolvedAt,lastUpdated:e.lastUpdated,notified:e._notified||!1}}),console.log(`[DB] Saved context for ${e.caseNumber}`)}catch(t){console.error(`[DB] Error saving context for ${e.caseNumber}:`,t)}}async saveMessage(e,t,s){let n=(0,o.zA)();if(n)try{await n.insert(r.caseMessages).values({caseNumber:e,threadTs:t,userId:s.user,messageText:s.text,messageTimestamp:s.timestamp}),console.log(`[DB] Saved message for ${e}`)}catch(t){console.error(`[DB] Error saving message for ${e}:`,t)}}async loadContext(e,t){let s=(0,o.zA)();if(s)try{let a=await s.select().from(r.caseContexts).where((0,n.xD)((0,n.eq)(r.caseContexts.caseNumber,e),(0,n.eq)(r.caseContexts.threadTs,t))).limit(1);if(0===a.length)return;let o=a[0],i=(await s.select().from(r.caseMessages).where((0,n.xD)((0,n.eq)(r.caseMessages.caseNumber,e),(0,n.eq)(r.caseMessages.threadTs,t))).orderBy(r.caseMessages.messageTimestamp)).map(e=>({user:e.userId,text:e.messageText,timestamp:e.messageTimestamp,thread_ts:t})),l={caseNumber:o.caseNumber,threadTs:o.threadTs,channelId:o.channelId,channelName:o.channelName||void 0,messages:i,detectedAt:o.detectedAt,lastUpdated:o.lastUpdated,isResolved:o.isResolved,resolvedAt:o.resolvedAt||void 0,_notified:o.notified};return console.log(`[DB] Loaded context for ${e} with ${i.length} messages`),l}catch(t){console.error(`[DB] Error loading context for ${e}:`,t);return}}async loadAllActiveContexts(e=72){let t=(0,o.zA)();if(!t)return[];try{let s=new Date;s.setHours(s.getHours()-e);let o=await t.select().from(r.caseContexts).where((0,n.eg)(r.caseContexts.lastUpdated,s)).orderBy((0,a.C)(r.caseContexts.lastUpdated));console.log(`[DB] Loading ${o.length} active contexts`);let i=[];for(let e of o){let s=(await t.select().from(r.caseMessages).where((0,n.xD)((0,n.eq)(r.caseMessages.caseNumber,e.caseNumber),(0,n.eq)(r.caseMessages.threadTs,e.threadTs))).orderBy(r.caseMessages.messageTimestamp)).map(t=>({user:t.userId,text:t.messageText,timestamp:t.messageTimestamp,thread_ts:e.threadTs}));i.push({caseNumber:e.caseNumber,threadTs:e.threadTs,channelId:e.channelId,channelName:e.channelName||void 0,messages:s,detectedAt:e.detectedAt,lastUpdated:e.lastUpdated,isResolved:e.isResolved,resolvedAt:e.resolvedAt||void 0,_notified:e.notified})}return console.log(`[DB] Loaded ${i.length} active contexts from database`),i}catch(e){return console.error("[DB] Error loading active contexts:",e),[]}}async loadContextsForCase(e){let t=(0,o.zA)();if(!t)return[];try{let s=await t.select().from(r.caseContexts).where((0,n.eq)(r.caseContexts.caseNumber,e)).orderBy((0,a.C)(r.caseContexts.lastUpdated)),o=[];for(let e of s){let s=(await t.select().from(r.caseMessages).where((0,n.xD)((0,n.eq)(r.caseMessages.caseNumber,e.caseNumber),(0,n.eq)(r.caseMessages.threadTs,e.threadTs))).orderBy(r.caseMessages.messageTimestamp)).map(t=>({user:t.userId,text:t.messageText,timestamp:t.messageTimestamp,thread_ts:e.threadTs}));o.push({caseNumber:e.caseNumber,threadTs:e.threadTs,channelId:e.channelId,channelName:e.channelName||void 0,messages:s,detectedAt:e.detectedAt,lastUpdated:e.lastUpdated,isResolved:e.isResolved,resolvedAt:e.resolvedAt||void 0,_notified:e.notified})}return console.log(`[DB] Loaded ${o.length} contexts for case ${e}`),o}catch(t){return console.error(`[DB] Error loading contexts for case ${e}:`,t),[]}}async markAsNotified(e,t){let s=(0,o.zA)();if(s)try{await s.update(r.caseContexts).set({notified:!0}).where((0,n.xD)((0,n.eq)(r.caseContexts.caseNumber,e),(0,n.eq)(r.caseContexts.threadTs,t))),console.log(`[DB] Marked ${e} as notified`)}catch(t){console.error(`[DB] Error marking ${e} as notified:`,t)}}async deleteOldContexts(e){let t=(0,o.zA)();if(!t)return 0;try{let s=new Date;s.setHours(s.getHours()-e);let a=await t.select({caseNumber:r.caseContexts.caseNumber,threadTs:r.caseContexts.threadTs}).from(r.caseContexts).where((0,n.lt)(r.caseContexts.lastUpdated,s));if(0===a.length)return 0;for(let e of a)await t.delete(r.caseMessages).where((0,n.xD)((0,n.eq)(r.caseMessages.caseNumber,e.caseNumber),(0,n.eq)(r.caseMessages.threadTs,e.threadTs)));let o=(await t.delete(r.caseContexts).where((0,n.lt)(r.caseContexts.lastUpdated,s))).rowCount||0;return console.log(`[DB] Deleted ${o} old contexts`),o}catch(e){return console.error("[DB] Error deleting old contexts:",e),0}}}let l=null;class c{constructor(e=20,t=72,s){this.contexts=new Map,this.maxMessagesPerCase=e,this.maxAgeHours=t,this.repository=s||(l||(l=new i),l)}extractCaseNumbers(e){let t=e.match(/\b[A-Z]{3}\d{7}\b/g);return t?[...new Set(t)]:[]}addMessage(e,t,s,n){let a=this.getContextKey(e,s),o=this.contexts.get(a);o||(o={caseNumber:e,threadTs:s,channelId:t,messages:[],detectedAt:new Date,lastUpdated:new Date},this.contexts.set(a,o)),o.messages.push(n),o.lastUpdated=new Date,o.messages.length>this.maxMessagesPerCase&&(o.messages=o.messages.slice(-this.maxMessagesPerCase)),this.checkForResolution(o,n),this.repository.saveContext(o).catch(e=>{console.error("[ContextManager] Failed to save context:",e)}),this.repository.saveMessage(e,s,n).catch(e=>{console.error("[ContextManager] Failed to save message:",e)})}checkForResolution(e,t){if(e.isResolved||new Date().getTime()-e.detectedAt.getTime()<3e5||[/\?$/,/is (it|this|that) (fixed|resolved|working|closed|done)/i,/can (you|we|someone) (fix|resolve|close)/i,/will (it|this|that) be (fixed|resolved|closed)/i,/what if (it's|it is|this is) (fixed|resolved|working)/i,/should (we|i) (fix|resolve|close)/i,/(help|issue|problem|error|failed|failing|broken)/i].some(e=>e.test(t.text)))return;let s=[/\b(fixed|resolved|closed) (it|this|that|the issue|the problem)\b/i,/\b(it's|it is|this is) (fixed|resolved|working now|all set)\b/i,/\bproblem (solved|fixed|resolved)\b/i,/\bissue (resolved|fixed|closed)\b/i,/\b(successfully|completed|done) (fixed|resolved|closed)\b/i,/\b(working|operational) (now|again)\b/i].some(e=>e.test(t.text)),n=e.messages.slice(-3).some(e=>e.text.includes("?"));s&&!n&&(console.log(`[ContextManager] Detected resolution for ${e.caseNumber} from message: "${t.text.substring(0,100)}"`),e.isResolved=!0,e.resolvedAt=new Date)}async getContext(e,t){let s=this.getContextKey(e,t),n=this.contexts.get(s);if(n)return n;try{return(n=await this.repository.loadContext(e,t))&&(this.contexts.set(s,n),console.log(`[ContextManager] Loaded context for ${e} from database`)),n??void 0}catch(e){console.error("[ContextManager] Error loading context from DB:",e);return}}getContextSync(e,t){return this.contexts.get(this.getContextKey(e,t))}getContextsForCase(e){return Array.from(this.contexts.values()).filter(t=>t.caseNumber===e)}getResolvedContexts(){return Array.from(this.contexts.values()).filter(e=>e.isResolved&&e.messages.length>=3)}getActiveContextsForChannel(e){return Array.from(this.contexts.values()).filter(t=>t.channelId===e&&!t.isResolved)}markAsProcessed(e,t){let s=this.getContextKey(e,t);this.contexts.delete(s)}async loadFromDatabase(){try{console.log("[ContextManager] Loading contexts from database...");let e=await this.repository.loadAllActiveContexts(this.maxAgeHours);for(let t of e){let e=this.getContextKey(t.caseNumber,t.threadTs);this.contexts.set(e,t)}console.log(`[ContextManager] Loaded ${e.length} contexts from database`)}catch(e){console.error("[ContextManager] Error loading contexts from database:",e)}}async cleanupOldContexts(){let e=new Date().getTime()-36e5*this.maxAgeHours,t=0;for(let[s,n]of this.contexts.entries())n.lastUpdated.getTime()<e&&(this.contexts.delete(s),t++);try{let e=await this.repository.deleteOldContexts(this.maxAgeHours);console.log(`[ContextManager] Cleaned up ${t} from memory, ${e} from database`)}catch(e){console.error("[ContextManager] Error cleaning up database:",e)}return t}getStats(){return{totalContexts:this.contexts.size,resolvedContexts:Array.from(this.contexts.values()).filter(e=>e.isResolved).length,oldestContext:this.getOldestContext()}}getContextKey(e,t){return`${e}:${t}`}getOldestContext(){let e=null;for(let t of this.contexts.values())(!e||t.detectedAt<e)&&(e=t.detectedAt);return e}getSummary(e,t){let s=this.getContextSync(e,t);return s&&0!==s.messages.length?s.messages.map(e=>`[${e.timestamp}] ${e.user}: ${e.text}`).join("\n"):null}}let d=null;function u(){return d||(d=new c),d}},51921:(e,t,s)=>{"use strict";s.d(t,{xQ:()=>l,zA:()=>i});var n=s(4530),a=s(67461),o=s(19954);let r=null;function i(){if(!r){let e=process.env.DATABASE_URL;if(!e)return console.warn("[Database] DATABASE_URL not configured. Running in memory-only mode."),null;try{let t=(0,a.qn)(e);r=(0,n.tS)(t,{schema:o}),console.log("[Database] Connected to Neon Postgres")}catch(e){return console.error("[Database] Failed to initialize connection:",e),null}}return r}function l(){return!!process.env.DATABASE_URL}},86632:(e,t,s)=>{"use strict";s.r(t),s.d(t,{BusinessContextRepository:()=>r,getBusinessContextRepository:()=>l});var n=s(30513),a=s(19954),o=s(51921);class r{async findByName(e){let t=(0,o.zA)();if(!t)return null;try{return(await t.select().from(a.businessContexts).where((0,n.xD)((0,n.o$)(a.businessContexts.entityName,e),(0,n.eq)(a.businessContexts.isActive,!0))).limit(1))[0]||null}catch(t){return console.error(`[Business Context Repo] Error finding by name "${e}":`,t),null}}async findByNameOrAlias(e){let t=(0,o.zA)();if(!t)return null;try{let s=await this.findByName(e);if(s)return s;let o=await t.select().from(a.businessContexts).where((0,n.eq)(a.businessContexts.isActive,!0)),r=e.toLowerCase();for(let e of o)if(e.aliases&&Array.isArray(e.aliases)&&e.aliases.some(e=>e.toLowerCase()===r))return e;return null}catch(t){return console.error(`[Business Context Repo] Error finding by name or alias "${e}":`,t),null}}async getAllActive(){let e=(0,o.zA)();if(!e)return[];try{return await e.select().from(a.businessContexts).where((0,n.eq)(a.businessContexts.isActive,!0)).orderBy(a.businessContexts.entityName)}catch(e){return console.error("[Business Context Repo] Error getting all active:",e),[]}}async getAll(){let e=(0,o.zA)();if(!e)return[];try{return await e.select().from(a.businessContexts).orderBy(a.businessContexts.entityName)}catch(e){return console.error("[Business Context Repo] Error getting all:",e),[]}}async findById(e){let t=(0,o.zA)();if(!t)return null;try{return(await t.select().from(a.businessContexts).where((0,n.eq)(a.businessContexts.id,e)).limit(1))[0]||null}catch(t){return console.error(`[Business Context Repo] Error finding by ID ${e}:`,t),null}}async getByType(e){let t=(0,o.zA)();if(!t)return[];try{return await t.select().from(a.businessContexts).where((0,n.xD)((0,n.eq)(a.businessContexts.entityType,e),(0,n.eq)(a.businessContexts.isActive,!0))).orderBy(a.businessContexts.entityName)}catch(t){return console.error(`[Business Context Repo] Error getting by type "${e}":`,t),[]}}async create(e){let t=(0,o.zA)();if(!t)return null;try{return(await t.insert(a.businessContexts).values(e).returning())[0]||null}catch(e){return console.error("[Business Context Repo] Error creating context:",e),null}}async update(e,t){let s=(0,o.zA)();if(!s)return null;try{return(await s.update(a.businessContexts).set({...t,updatedAt:new Date}).where((0,n.eq)(a.businessContexts.id,e)).returning())[0]||null}catch(t){return console.error(`[Business Context Repo] Error updating context ${e}:`,t),null}}async appendCmdbIdentifier(e,t,s={}){let r=(0,o.zA)();if(!r)return null;let i=await this.findByName(e);if(!i){if(!s.createIfMissing)return console.warn(`[Business Context Repo] appendCmdbIdentifier skipped ‚Äì ${e} does not exist`),null;if(!s.entityType)throw Error(`Cannot create ${e} without entityType when appending CMDB identifier`);let n={entityName:e,entityType:s.entityType,industry:s.defaults?.industry,description:s.defaults?.description,aliases:s.defaults?.aliases??[],relatedEntities:s.defaults?.relatedEntities??[],technologyPortfolio:s.defaults?.technologyPortfolio,serviceDetails:s.defaults?.serviceDetails,keyContacts:s.defaults?.keyContacts??[],slackChannels:s.defaults?.slackChannels??[],cmdbIdentifiers:[t],contextStewards:s.defaults?.contextStewards??[],isActive:s.defaults?.isActive??!0};return await this.create(n)}let l=Array.isArray(i.cmdbIdentifiers)?i.cmdbIdentifiers:[];if(l.some(e=>{if(t.sysId&&e.sysId&&e.sysId===t.sysId||t.ciName&&e.ciName&&e.ciName.toLowerCase()===t.ciName.toLowerCase())return!0;if(t.ipAddresses?.length){let s=t.ipAddresses.map(e=>e.trim()),n=e.ipAddresses?.map(e=>e.trim())??[];if(s.some(e=>n.includes(e)))return!0}return!1}))return console.log(`[Business Context Repo] CMDB identifier already present for ${e}, skipping append.`),i;let c=[...l,t];return(await r.update(a.businessContexts).set({cmdbIdentifiers:c,updatedAt:new Date}).where((0,n.eq)(a.businessContexts.id,i.id)).returning())[0]||null}async deactivate(e){let t=(0,o.zA)();if(!t)return!1;try{return await t.update(a.businessContexts).set({isActive:!1,updatedAt:new Date}).where((0,n.eq)(a.businessContexts.id,e)),!0}catch(t){return console.error(`[Business Context Repo] Error deactivating context ${e}:`,t),!1}}async delete(e){let t=(0,o.zA)();if(!t)return!1;try{return await t.delete(a.businessContexts).where((0,n.eq)(a.businessContexts.id,e)),!0}catch(t){return console.error(`[Business Context Repo] Error deleting context ${e}:`,t),!1}}}let i=null;function l(){return i||(i=new r),i}},19954:(e,t,s)=>{"use strict";s.r(t),s.d(t,{businessContexts:()=>g,caseContexts:()=>h,caseMessages:()=>m,kbGenerationStates:()=>p});var n=s(48003),a=s(50017),o=s(44602),r=s(19766),i=s(26428),l=s(94212),c=s(47256),d=s(84825),u=s(64605);let h=(0,n.af)("case_contexts",{caseNumber:(0,a.fL)("case_number").notNull(),threadTs:(0,a.fL)("thread_ts").notNull(),channelId:(0,a.fL)("channel_id").notNull(),channelName:(0,a.fL)("channel_name"),channelTopic:(0,a.fL)("channel_topic"),channelPurpose:(0,a.fL)("channel_purpose"),isResolved:(0,o.O7)("is_resolved").default(!1).notNull(),resolvedAt:(0,r.AB)("resolved_at"),detectedAt:(0,r.AB)("detected_at").notNull().defaultNow(),lastUpdated:(0,r.AB)("last_updated").notNull().defaultNow(),notified:(0,o.O7)("notified").default(!1).notNull(),hasPostedAssistance:(0,o.O7)("has_posted_assistance").default(!1).notNull()},e=>({pk:(0,i.CK)({columns:[e.caseNumber,e.threadTs]}),resolvedIdx:(0,l.Kz)("idx_resolved").on(e.isResolved,e.notified),caseNumberIdx:(0,l.Kz)("idx_case_number").on(e.caseNumber),lastUpdatedIdx:(0,l.Kz)("idx_last_updated").on(e.lastUpdated)})),m=(0,n.af)("case_messages",{id:(0,c.eP)("id").primaryKey(),caseNumber:(0,a.fL)("case_number").notNull(),threadTs:(0,a.fL)("thread_ts").notNull(),userId:(0,a.fL)("user_id").notNull(),messageText:(0,a.fL)("message_text").notNull(),messageTimestamp:(0,a.fL)("message_timestamp").notNull(),createdAt:(0,r.AB)("created_at").notNull().defaultNow()},e=>({caseThreadIdx:(0,l.Kz)("idx_case_thread").on(e.caseNumber,e.threadTs),timestampIdx:(0,l.Kz)("idx_timestamp").on(e.messageTimestamp)})),p=(0,n.af)("kb_generation_states",{caseNumber:(0,a.fL)("case_number").notNull(),threadTs:(0,a.fL)("thread_ts").notNull(),channelId:(0,a.fL)("channel_id").notNull(),state:(0,a.fL)("state").notNull(),attemptCount:(0,d._L)("attempt_count").notNull().default(0),userResponses:(0,u.JB)("user_responses").$type().default([]).notNull(),assessmentScore:(0,d._L)("assessment_score"),missingInfo:(0,u.JB)("missing_info").$type().default([]).notNull(),startedAt:(0,r.AB)("started_at").notNull().defaultNow(),lastUpdated:(0,r.AB)("last_updated").notNull().defaultNow()},e=>({pk:(0,i.CK)({columns:[e.caseNumber,e.threadTs]}),stateIdx:(0,l.Kz)("idx_state").on(e.state),lastUpdatedStateIdx:(0,l.Kz)("idx_last_updated_state").on(e.lastUpdated)})),g=(0,n.af)("business_contexts",{id:(0,c.eP)("id").primaryKey(),entityName:(0,a.fL)("entity_name").notNull().unique(),entityType:(0,a.fL)("entity_type").notNull(),industry:(0,a.fL)("industry"),description:(0,a.fL)("description"),aliases:(0,u.JB)("aliases").$type().default([]).notNull(),relatedEntities:(0,u.JB)("related_entities").$type().default([]).notNull(),technologyPortfolio:(0,a.fL)("technology_portfolio"),serviceDetails:(0,a.fL)("service_details"),keyContacts:(0,u.JB)("key_contacts").$type().default([]).notNull(),slackChannels:(0,u.JB)("slack_channels").$type().default([]).notNull(),cmdbIdentifiers:(0,u.JB)("cmdb_identifiers").$type().default([]).notNull(),contextStewards:(0,u.JB)("context_stewards").$type().default([]).notNull(),isActive:(0,o.O7)("is_active").default(!0).notNull(),createdAt:(0,r.AB)("created_at").notNull().defaultNow(),updatedAt:(0,r.AB)("updated_at").notNull().defaultNow()},e=>({entityNameIdx:(0,l.Kz)("idx_entity_name").on(e.entityName),entityTypeIdx:(0,l.Kz)("idx_entity_type").on(e.entityType),isActiveIdx:(0,l.Kz)("idx_is_active").on(e.isActive)}))},13078:(e,t,s)=>{"use strict";s.d(t,{V:()=>r});var n=s(27467);class a{async postForApproval(e,t,s,a,o){let r=await n.Lp.chat.postMessage({channel:t,thread_ts:s,text:o,unfurl_links:!1});if(!r.ts)throw Error("Failed to post KB approval message - no timestamp returned");this.storePendingApproval(r.ts,t,e,a,s)}storePendingApproval(e,t,s,n,a){let o=this.getApprovalKey(t,e);this.pendingApprovals.set(o,{caseNumber:s,article:n,messageTs:e,channelId:t,threadTs:a,createdAt:new Date}),setTimeout(()=>{this.pendingApprovals.delete(o)},864e5)}async handleReaction(e,t,s,n){let a=this.getApprovalKey(e,t),o=this.pendingApprovals.get(a);o&&("+1"===s||"white_check_mark"===s||"heavy_check_mark"===s?(await this.handleApproval(o,n),this.pendingApprovals.delete(a)):("-1"===s||"x"===s||"negative_squared_cross_mark"===s)&&(await this.handleRejection(o,n),this.pendingApprovals.delete(a)))}async handleApproval(e,t){try{await n.Lp.chat.update({channel:e.channelId,ts:e.messageTs,text:`‚úÖ *KB Article Approved* by <@${t}>`,blocks:[{type:"section",text:{type:"mrkdwn",text:`‚úÖ *KB Article Approved* by <@${t}>

_Case: ${e.caseNumber}_`}},{type:"divider"},{type:"section",text:{type:"mrkdwn",text:this.formatApprovedArticle(e.article)}}]}),await n.Lp.chat.postMessage({channel:e.channelId,thread_ts:e.threadTs,text:`‚úÖ Knowledge base article for ${e.caseNumber} has been approved!

_Next step: This article can be added to ServiceNow knowledge base._

*Article Summary:*
${e.article.title}`})}catch(t){console.error("Error handling KB approval:",t),await n.Lp.chat.postMessage({channel:e.channelId,thread_ts:e.threadTs,text:`‚ùå Error processing approval: ${t instanceof Error?t.message:"Unknown error"}`})}}async handleRejection(e,t){try{await n.Lp.chat.update({channel:e.channelId,ts:e.messageTs,text:`‚ùå *KB Article Rejected* by <@${t}>`,blocks:[{type:"section",text:{type:"mrkdwn",text:`‚ùå *KB Article Rejected* by <@${t}>

_Case: ${e.caseNumber}_`}}]}),await n.Lp.chat.postMessage({channel:e.channelId,thread_ts:e.threadTs,text:`‚ùå Knowledge base article for ${e.caseNumber} was rejected.

_The article draft will not be created._`})}catch(e){console.error("Error handling KB rejection:",e)}}formatApprovedArticle(e){let t=`*${e.title}*

`;return t+=`üìã *Problem:* ${e.problem.substring(0,150)}${e.problem.length>150?"...":""}

‚úÖ *Solution:* ${e.solution.substring(0,200)}${e.solution.length>200?"...":""}

`,e.tags.length>0&&(t+=`üè∑Ô∏è *Tags:* ${e.tags.slice(0,5).join(", ")}`),t}getApprovalKey(e,t){return`${e}:${t}`}getPendingCount(){return this.pendingApprovals.size}cleanupOldApprovals(){let e=new Date().getTime()-864e5,t=0;for(let[s,n]of this.pendingApprovals.entries())n.createdAt.getTime()<e&&(this.pendingApprovals.delete(s),t++);return t}async createInServiceNow(e,t){console.log(`TODO: Create KB article in ServiceNow for case ${t}`,e.title)}constructor(){this.pendingApprovals=new Map}}let o=null;function r(){return o||(o=new a,setInterval(()=>{let e=o.cleanupOldApprovals();e>0&&console.log(`Cleaned up ${e} old KB approval requests`)},36e5)),o}},90349:(e,t,s)=>{"use strict";s.d(t,{I7:()=>L,v9:()=>I,xl:()=>k});var n=s(27467),a=s(7047),o=s(37929),r=s(44380),i=s(13078),l=s(45540),c=s(7644),d=s(96353),u=s(51362),h=s(5079),m=s(90916);let p=h.Ry({score:h.Rx().int().min(0).max(100),problemClarity:h.Km(["clear","vague","missing"]),solutionClarity:h.Km(["clear","vague","missing"]),stepsDocumented:h.O7(),rootCauseIdentified:h.O7(),missingInfo:h.IX(h.Z_().max(50)).max(4),reasoning:h.Z_().max(120)}),g=(0,d.w3)({description:"Return your quality assessment for the case as structured data. You must call this exactly once.",inputSchema:p,execute:async e=>e});async function f(e,t){let s=e.messages.map(e=>`${e.user}: ${e.text}`).join("\n"),n=t?`
Case Number: ${t.number||"N/A"}
Status: ${t.state||"N/A"}
Priority: ${t.priority||"N/A"}
Description: ${t.description||t.short_description||"N/A"}
`.trim():"No ServiceNow case details available.";try{let e;console.log("[Quality Analyzer] Assessing case quality...");let t=(await (0,u._4)({model:m.Q.languageModel("quality-analyzer"),system:"You are a meticulous knowledge base quality analyst. You must call the `report_quality` tool exactly once with your structured assessment.",prompt:`**Case Information:**
${n}

**Conversation History:**
${s}

Analyze this case using the criteria provided and call the tool with your findings.`,tools:{report_quality:g},toolChoice:{type:"tool",toolName:"report_quality"}})).toolResults[0];if(!t||"tool-result"!==t.type)throw Error("Model did not return a structured quality assessment");let a=p.parse(t.output),o={decision:e=a.score>=80?"high_quality":a.score>=50?"needs_input":"insufficient",score:a.score,problemClarity:a.problemClarity,solutionClarity:a.solutionClarity,stepsDocumented:a.stepsDocumented,rootCauseIdentified:a.rootCauseIdentified,missingInfo:a.missingInfo??[],reasoning:a.reasoning};return console.log(`[Quality Analyzer] Assessment: ${e} (score: ${o.score})`),console.log(`[Quality Analyzer] Missing: ${o.missingInfo.join(", ")}`),o}catch(e){return console.error("[Quality Analyzer] Error assessing quality:",e),{decision:"needs_input",score:50,problemClarity:"vague",solutionClarity:"vague",stepsDocumented:!1,rootCauseIdentified:!1,missingInfo:["Unable to assess - analysis error"],reasoning:"Error during quality assessment, defaulting to needs_input"}}}let y=null;async function _(e,t,s){let n=t.messages.slice(-5).map(e=>`${e.user}: ${e.text}`).join("\n"),a=`You are a friendly knowledge management assistant helping to create a KB article for case ${s}.

**What we know so far:**
${n}

**Quality Assessment:**
- Problem Clarity: ${e.problemClarity}
- Solution Clarity: ${e.solutionClarity}
- Steps Documented: ${e.stepsDocumented?"Yes":"No"}
- Root Cause Identified: ${e.rootCauseIdentified?"Yes":"No"}
- Missing Information: ${e.missingInfo.join(", ")}

**Your Task:**
Generate 2-4 specific, contextual questions to gather the missing information. Questions should be:
- Friendly and appreciative of their work
- Specific to this case (not generic)
- Focused on what's actually missing
- Easy to answer quickly

**Question Types:**
- If problem vague: Ask about symptoms, error messages, user impact
- If solution vague: Ask about specific steps taken, tools used
- If no root cause: Ask what caused the issue
- If no steps: Ask for step-by-step instructions

Return ONLY valid JSON:
{
  "questions": [<array of 2-4 question strings>],
  "tone": "friendly",
  "context": "<one sentence explaining why we need this info>"
}

Example:
{
  "questions": [
    "What was the root cause of the Foxit crash?",
    "What specific steps did you take to resolve it?",
    "Should users try this themselves or escalate to support?"
  ],
  "tone": "friendly",
  "context": "This will help the team handle similar issues faster"
}`;try{console.log("[KB Assistant] Generating gathering questions...");let e={model:m.Q.languageModel("kb-assistant"),prompt:a},{text:t}=await (0,u._4)(e),s=t.match(/\{[\s\S]*\}/);if(!s)throw Error("No JSON found in questions response");let n=JSON.parse(s[0]);return console.log(`[KB Assistant] Generated ${n.questions.length} questions`),n}catch(s){console.error("[KB Assistant] Error generating questions:",s);let t=[];return(e.missingInfo.includes("root cause")||!e.rootCauseIdentified)&&t.push("What caused this issue?"),(e.missingInfo.includes("steps")||!e.stepsDocumented)&&t.push("What steps did you take to resolve it?"),"clear"!==e.solutionClarity&&t.push("How exactly did you fix this?"),{questions:t.length>0?t:["Can you provide more details about how you resolved this?"],tone:"friendly",context:"This will help create a helpful KB article for the team"}}}async function C({caseNumber:e,context:t,caseDetails:s,journalEntries:n}){let a=function(e){let t=e.messages.slice(-12).map(e=>`${e.user}: ${e.text}`.trim()).filter(Boolean);return t.length>0?t.join("\n"):"No conversation captured."}(t),o=n?.length?n.slice(0,6).map(e=>{let t=e.sys_created_on,s=e.sys_created_by||"unknown",n="work_notes"===e.element?"Work note":"Comment",a=e.value?.replace(/\s+/g," ").trim()??"(no content)";return`${t} ‚Äì ${s} (${n}): ${a}`}).join("\n"):"No recent journal activity.",r=function(e){if(!e)return"Not available.";let t=[e.short_description?`Short description: ${e.short_description}`:null,e.description?`Description: ${e.description}`:null,e.state?`State: ${e.state}`:null,e.priority?`Priority: ${e.priority}`:null,e.assignment_group?`Assignment group: ${e.assignment_group}`:null,e.assigned_to?`Assigned to: ${e.assigned_to}`:null,e.submitted_by?`Requester: ${e.submitted_by}`:null].filter(Boolean);return t.length>0?t.join("\n"):"Limited metadata available."}(s??null),i=`You are an internal Service Desk assistant. Summarize the resolved case below for a support analyst audience.

Case Number: ${e}

ServiceNow Details:
${r}

Recent Journal Activity:
${o}

Conversation Excerpt:
${a}

Produce a Slack-formatted message with:
*Resolution Summary* ‚Äì 2-4 bullets explaining the issue, root cause, and fix.
*Latest Updates* ‚Äì bullet the most recent actions (chronological).
*Outstanding Items* ‚Äì list follow-up actions or state "- None noted." if nothing remains.

Keep bullets concise (‚â§140 characters) and avoid repeating the case number. Do not invent details beyond the provided information.`;try{let e={model:m.Q.languageModel("resolution-summary"),prompt:i},{text:t}=await (0,u._4)(e),s=t.trim();if(0===s.length)return null;return s}catch(a){console.error("[ResolutionSummary] Failed to generate summary:",a);let n=[`‚úÖ Case ${e} marked resolved.`,s?.short_description?`‚Ä¢ Issue: ${s.short_description}`:void 0,t.messages.length>0?`‚Ä¢ Last comment from ${t.messages[t.messages.length-1]?.user??"user"}: ${t.messages[t.messages.length-1]?.text}`:void 0].filter(Boolean);return n.length>0?n.join("\n"):null}}var v=s(39045),x=s(23271);let w=h.Ry({similarCases:h.IX(h.Z_().max(120)).min(1).max(3),suggestions:h.IX(h.Z_().max(100)).min(1).max(4),nextSteps:h.IX(h.Z_().max(100)).min(1).max(3)}),b=(0,d.w3)({description:"Provide actionable guidance for the analyst. Call exactly once with structured bullet points.",inputSchema:w,execute:async e=>e});async function $(e,t,s,n,a,o){let r=`üëã I see you're working on *${e}*`;if(n&&(r+=` in #${n}`),t){let e=t.state||"Unknown",s=t.priority?`P${t.priority}`:"",n=t.short_description||"";if(r+=`

*Status:* ${e}`,s&&(r+=` | *Priority:* ${s}`),n){let e=n.length>100?n.substring(0,100)+"...":n;r+=`
*Issue:* ${e}`}}let i=t?.description||t?.short_description||"";if(s){if(t){if(i)try{console.log(`[Intelligent Assistant] Searching for similar cases to ${e}: "${i.substring(0,100)}${i.length>100?"...":""}"`);let l=await A(t,s,n,a,o);l?(console.log(`[Intelligent Assistant] Generated guidance for ${e}`),r+=`

${l}`):console.log(`[Intelligent Assistant] No guidance generated for ${e} (no similar cases or description too short)`)}catch(t){console.error("[Intelligent Assistant] Error generating guidance:",{caseNumber:e,error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0,hasSearchService:!!s,descriptionLength:i.length})}else console.log(`[Intelligent Assistant] No problem description for ${e} - skipping similarity search`)}else console.log(`[Intelligent Assistant] No case details available for ${e} - skipping similarity search`)}else console.warn(`[Intelligent Assistant] Azure Search not configured - skipping similarity search for ${e}`);return r+`

_I'll track this conversation for knowledge base generation._ üìù`}async function A(e,t,s,n,a){let o=e.description||e.short_description||"";if(!o||o.length<v.v.assistantMinDescriptionLength)return console.log(`[Intelligent Assistant] Description too short for search: "${o}" (${o.length} chars)`),null;console.log(`[Intelligent Assistant] Calling Azure Search with query: "${o.substring(0,80)}..."`);let r=await t.searchSimilarCases(o,{topK:v.v.assistantSimilarCasesTopK});return(console.log(`[Intelligent Assistant] Azure Search returned ${r.length} similar cases`),0===r.length)?(console.log("[Intelligent Assistant] No similar cases found - skipping guidance generation"),null):(r.forEach((e,t)=>{console.log(`[Intelligent Assistant]   ${t+1}. ${e.case_number} (score: ${e.score.toFixed(2)})`)}),await N(e,r,s,n,a))}async function N(e,t,s,n,a){let o=e.description||e.short_description||"",r=t.map((e,t)=>`${t+1}. Case ${e.case_number} (similarity: ${(100*e.score).toFixed(0)}%)
${e.content.substring(0,300)}...`).join("\n\n"),i=`You are a Service Desk AI assistant helping an engineer troubleshoot a case.

**Current Case:**
${o}

**Similar Historical Cases:**
${r}

When ready, call the \`draft_case_guidance\` tool EXACTLY ONCE with:
- similarCases: 1-3 bullet strings summarising matched cases (case number + fix)
- suggestions: 2-4 tactical troubleshooting ideas (‚â§80 chars each)
- nextSteps: 1-3 immediate follow-up actions (‚â§80 chars each)

Prioritise actionable insights only.`;try{var l;let e;let t=(0,x.X)(),o=await t.enhancePromptWithContext(i,s,n,a),r=(await (0,u._4)({model:m.Q.languageModel("intelligent-assistant"),system:"You are a proactive support co-pilot. ALWAYS call the `draft_case_guidance` tool exactly once with concise bullets.",prompt:o,tools:{draft_case_guidance:b},toolChoice:{type:"tool",toolName:"draft_case_guidance"}})).toolResults[0];if(!r||"tool-result"!==r.type)throw Error("Structured guidance not returned");return l=w.parse(r.output),e="*Similar Cases Found:*\n"+l.similarCases.map(e=>`‚Ä¢ ${e}`).join("\n"),l.suggestions.length>0&&(e+="\n\n*Suggestions:*\n"+l.suggestions.map(e=>`‚Ä¢ ${e}`).join("\n")),l.nextSteps.length>0&&(e+="\n\n*Next Steps:*\n"+l.nextSteps.map(e=>`‚Ä¢ ${e}`).join("\n")),e}catch(e){return console.error("[Intelligent Assistant] Error synthesizing guidance:",e),`*Similar Cases Found:*
${t.map(e=>`‚Ä¢ ${e.case_number} - ${e.content.substring(0,80)}...`).join("\n")}`}}var S=s(5028);async function I(e,t){if(!(e.bot_id||e.user===t||!e.text||""===e.text.trim()||e.text.includes(`<@${t}>`))){for(let s of(0,a.c)().extractCaseNumbers(e.text))await E(e,s,t);e.thread_ts&&await T(e)}}async function E(e,t,s){let r=(0,a.c)(),i=e.thread_ts||e.ts,c=e.channel;r.addMessage(t,c,i,{user:e.user||"unknown",text:e.text||"",timestamp:e.ts,thread_ts:e.thread_ts});let d=r.getContextSync(t,i);if(d&&!d.hasPostedAssistance){try{let e=await (0,l.F)(c);e&&d&&(d.channelName=e.channelName,d.channelTopic=e.channelTopic,d.channelPurpose=e.channelPurpose)}catch(e){console.warn(`Could not fetch channel info for ${c}:`,e)}try{let s=null;if(o.K.isConfigured())try{s=await o.K.getCase(t)}catch(e){console.warn(`Could not fetch case details for ${t}:`,e)}if(!function(e){if(!e)return!0;let t=e.state;if(!t)return!0;let s=v.v.assistantActiveStates.some(e=>t.toLowerCase().includes(e.toLowerCase()));return s||console.log(`[Intelligent Assistant] Skipping assistance for ${e.number||"case"} - state "${t}" not in active states`),s}(s)){console.log(`[Passive Monitor] Skipping assistance for ${t} - case is not in an active state`),await n.Lp.chat.postMessage({channel:c,thread_ts:e.ts,text:`üëã I see you're working on *${t}*. I'll track this conversation for knowledge base generation. üìù`,unfurl_links:!1}),d&&(d.hasPostedAssistance=!0);return}let a=(0,S.n)();console.log(`[Passive Monitor] Azure Search ${a?"ENABLED":"DISABLED"} for ${t}`);let r=await $(t,s,a,d?.channelName,d?.channelTopic,d?.channelPurpose);await n.Lp.chat.postMessage({channel:c,thread_ts:e.ts,text:r,unfurl_links:!1}),d&&(d.hasPostedAssistance=!0)}catch(e){console.error(`Error posting intelligent assistance for ${t}:`,e)}}}async function T(e){if(!e.thread_ts)return;let t=(0,a.c)();for(let s of Array.from(t.contexts.values()).filter(t=>t.threadTs===e.thread_ts&&t.channelId===e.channel)){if(console.log(`[Passive Monitor] Adding message to case ${s.caseNumber}, text: "${e.text}"`),t.addMessage(s.caseNumber,s.channelId,s.threadTs,{user:e.user||"unknown",text:e.text||"",timestamp:e.ts,thread_ts:e.thread_ts}),console.log(`[Passive Monitor] After addMessage - isResolved: ${s.isResolved}, _notified: ${s._notified}`),(0,c.hm)().isWaitingForUser(s.caseNumber,s.threadTs)){console.log(`[KB Generation] User response detected for ${s.caseNumber}, processing...`),await B(s,e.text||"");continue}if(s.isResolved&&!s._notified){let e=!1;if(o.K.isConfigured())try{let t=await o.K.getCase(s.caseNumber);(t?.state?.toLowerCase().includes("closed")||t?.state?.toLowerCase().includes("resolved"))&&(e=!0)}catch(e){console.log(`[Passive Monitor] Could not validate ServiceNow state for ${s.caseNumber}:`,e)}!o.K.isConfigured()||e?(console.log(`[Passive Monitor] Triggering KB generation for ${s.caseNumber} (ServiceNow confirmed: ${e})`),await k(s.caseNumber,s.channelId,s.threadTs),s._notified=!0):(console.log("[Passive Monitor] Skipping KB generation - conversation suggests resolution but ServiceNow state doesn't confirm it yet"),s.isResolved=!1)}else console.log(`[Passive Monitor] NOT triggering KB - isResolved: ${s.isResolved}, _notified: ${s._notified}`)}}async function B(e,t){var s;let a=(0,c.hm)(),r=e.caseNumber,i=e.threadTs,l=e.channelId;console.log(`[KB Generation] Processing user response for ${r}...`),a.addUserResponse(r,i,t);let d=o.K.isConfigured()?await o.K.getCase(r).catch(()=>null):null,u=(y||(y=f),y),h=await u(e,d);if(a.storeAssessment(r,i,h.score,h.missingInfo),console.log(`[KB Generation] Re-assessment: ${h.decision} (score: ${h.score})`),"high_quality"===h.decision)console.log("[KB Generation] Quality improved - proceeding to generation"),a.setState(r,i,c.zC.GENERATING),await K(r,l,i,e,d);else if(a.hasReachedMaxAttempts(r,i)){console.log("[KB Generation] Max attempts reached - abandoning"),a.setState(r,i,c.zC.ABANDONED);let e=`‚úÖ *${r}* is resolved! üéâ

_Not enough detail available for a KB article, but great work resolving the issue!_`;await n.Lp.chat.postMessage({channel:l,thread_ts:i,text:e,unfurl_links:!1}),a.remove(r,i)}else{let t;console.log("[KB Generation] Quality still insufficient - asking follow-up questions"),a.incrementAttempt(r,i),await _(h,e,r);let o=(s=h.missingInfo,t=`Thanks for the info on *${r}*!

Just need a couple more details:

`,s.forEach((e,s)=>{t+=`${s+1}. ${e}
`}),t+=`
This will really help make the KB article useful! üôå`);await n.Lp.chat.postMessage({channel:l,thread_ts:i,text:o,unfurl_links:!1}),console.log(`[KB Generation] Posted follow-up questions for ${r}`)}}async function k(e,t,s){console.log(`[KB Generation] Starting multi-stage process for ${e}`);let r=(0,a.c)().getContextSync(e,s);if(!r){console.log(`[KB Generation] No context found for ${e}, skipping`);return}console.log(`[KB Generation] Context found with ${r.messages.length} messages`);let i=null,l=[];if(o.K.isConfigured()){try{i=await o.K.getCase(e)}catch(t){console.error(`[KB Generation] Failed to fetch case details for ${e}:`,t)}if(i?.sys_id)try{l=await o.K.getCaseJournal(i.sys_id,{limit:10})}catch(t){console.error(`[KB Generation] Failed to fetch journal entries for ${e}:`,t)}}try{let a=await C({caseNumber:e,context:r,caseDetails:i,journalEntries:l});a&&await n.Lp.chat.postMessage({channel:t,thread_ts:s,text:a,unfurl_links:!1})}catch(t){console.error(`[KB Generation] Failed to post resolution summary for ${e}:`,t)}let d=(0,c.hm)();d.initialize(e,s,t);try{console.log("[KB Generation] Stage 1: Assessing quality...");let a=(y||(y=f),y),o=await a(r,i);if(d.storeAssessment(e,s,o.score,o.missingInfo),console.log(`[KB Generation] Quality: ${o.decision} (score: ${o.score})`),console.log(`[KB Generation] Reasoning: ${o.reasoning}`),"high_quality"===o.decision)console.log("[KB Generation] High quality - proceeding directly to generation"),d.setState(e,s,c.zC.GENERATING),await K(e,t,s,r,i);else if("needs_input"===o.decision)console.log("[KB Generation] Needs input - starting interactive gathering"),d.setState(e,s,c.zC.GATHERING),await R(e,t,s,o,r);else{var u;let a;console.log("[KB Generation] Insufficient quality - requesting case note updates"),d.setState(e,s,c.zC.AWAITING_NOTES);let r=(u=o.missingInfo,a=`‚úÖ Great that *${e}* is resolved!

I'd love to create a KB article, but need a bit more detail in the case notes.

*Please add to ServiceNow:*
`,u.forEach((e,t)=>{a+=`${t+1}. ${e}
`}),a+=`
_I'll check back in 24 hours. If the case notes are updated, I'll generate the KB then._ ‚è∞`);await n.Lp.chat.postMessage({channel:t,thread_ts:s,text:r,unfurl_links:!1}),console.log(`[KB Generation] Will check case notes for ${e} in ${v.v.kbGatheringTimeoutHours} hours`)}}catch(a){console.error(`[KB Generation] ERROR for ${e}:`,a),console.error("[KB Generation] Stack trace:",a instanceof Error?a.stack:"No stack trace");try{await n.Lp.chat.postMessage({channel:t,thread_ts:s,text:`‚úÖ It looks like *${e}* has been resolved!

_Error during KB generation: ${a instanceof Error?a.message:"Unknown error"}_`,unfurl_links:!1})}catch(e){console.error("[KB Generation] Failed to post error notification:",e)}d.setState(e,s,c.zC.ABANDONED),d.remove(e,s)}}async function K(e,t,s,a,o){console.log(`[KB Generation] Generating KB article for ${e}...`);let l=(0,r.B)(),d=await l.generateArticle(a,o);if(d.isDuplicate){let a=d.similarExistingKBs?.map(e=>`‚Ä¢ <${e.url}|${e.number}>: ${e.title}`).join("\n")||"";await n.Lp.chat.postMessage({channel:t,thread_ts:s,text:`‚úÖ *${e}* is resolved!

‚ÑπÔ∏è Similar KB articles already exist:
${a}

_Consider updating an existing article instead of creating a new one._`,unfurl_links:!1});let o=(0,c.hm)();o.setState(e,s,c.zC.ABANDONED),o.remove(e,s);return}let u=await D(e,d.article,d.confidence),h=(0,i.V)();await h.postForApproval(e,t,s,d.article,u),(0,c.hm)().setState(e,s,c.zC.PENDING_APPROVAL),console.log(`[KB Generation] Posted KB for approval: ${e}`)}async function R(e,t,s,a,o){let r;console.log(`[KB Generation] Starting interactive gathering for ${e}...`),(0,c.hm)().incrementAttempt(e,s);let i=await _(a,o,e),l=(r=`‚úÖ Great work resolving *${e}*!

To help train the team, I'd like to create a KB article.
However, I need a bit more detail:

`,i.questions.forEach((e,t)=>{r+=`${t+1}. ${e}
`}),r+=`
Reply here when you have a moment! üôè
_${i.context}_`);await n.Lp.chat.postMessage({channel:t,thread_ts:s,text:l,unfurl_links:!1}),console.log(`[KB Generation] Posted ${i.questions.length} questions for ${e}`)}async function D(e,t,s){return`‚úÖ *${e}* is resolved! I've generated a KB article draft:

*${t.title}*

${t.problem.substring(0,200)}${t.problem.length>200?"...":""}

_Confidence: ${s}% | React with ‚úÖ to publish or ‚ùå to skip_`}async function L(){let e=(0,c.hm)(),t=e.getContextsInState(c.zC.GATHERING),s=new Date,a=36e5*v.v.kbGatheringTimeoutHours;for(let r of t){let t=s.getTime()-r.lastUpdated.getTime();if(t>a){var o;console.log(`[KB Generation] Timing out gathering for ${r.caseNumber} (${Math.round(t/36e5)}h elapsed)`);let s=(o=r.caseNumber,`‚è∞ KB article request for *${o}* has timed out.

_No worries! Feel free to manually create a KB if needed._`);try{await n.Lp.chat.postMessage({channel:r.channelId,thread_ts:r.threadTs,text:s,unfurl_links:!1})}catch(e){console.error(`[KB Generation] Failed to post timeout message for ${r.caseNumber}:`,e)}e.setState(r.caseNumber,r.threadTs,c.zC.ABANDONED),e.remove(r.caseNumber,r.threadTs)}}}},90916:(e,t,s)=>{"use strict";s.d(t,{E:()=>h,Q:()=>u});var n=s(3831),a=s(75255),o=s(51362);let r=process.env.AI_GATEWAY_API_KEY?.trim(),i=process.env.AI_GATEWAY_DEFAULT_MODEL?.trim()??process.env.AI_GATEWAY_MODEL?.trim()??"zai/glm-4.6",l=process.env.OPENAI_FALLBACK_MODEL?.trim()??"gpt-5-mini",c=r?(0,n.rG)({apiKey:r}):null,d=c?c(i):(0,a.openai)(l),u=(0,o.Se)({languageModels:{"chat-model":d,"kb-generator":d,"quality-analyzer":d,"resolution-summary":d,"intelligent-assistant":d,"kb-assistant":d}});function h(){return c?i:l}},5028:(e,t,s)=>{"use strict";s.d(t,{n:()=>i});var n=s(92581),a=s(43071),o=s(55861);class r{constructor(e,t,s,r,i="text-embedding-3-small"){this.searchClient=new n.w(e,s,new a.s5(t)),this.openaiClient=new o.Pp({apiKey:r}),this.embeddingModel=i}async generateEmbedding(e){try{return(await this.openaiClient.embeddings.create({model:this.embeddingModel,input:e})).data[0].embedding}catch(e){throw console.error("Failed to generate embedding:",e),Error("Failed to generate query embedding")}}async searchSimilarCases(e,t={}){let{topK:s=5,clientId:n,filters:a={}}=t;try{let t=await this.generateEmbedding(e),o=[];for(let[e,t]of(n&&o.push(`client_id eq '${n}'`),Object.entries(a)))"string"==typeof t&&o.push(`${e} eq '${t}'`);let r=o.length>0?o.join(" and "):void 0,i=await this.searchClient.search("*",{vectorSearchOptions:{queries:[{kind:"vector",vector:t,kNearestNeighborsCount:s,fields:["embedding"]}]},select:["id","case_number","description","short_description","client_id","client_name","category","priority","quality_score","created_at","resolved_at"],top:s,filter:r}),l=[];for await(let e of i.results)l.push({id:e.document.id,case_number:e.document.case_number||"Unknown",content:e.document.description||e.document.short_description||"",filename:e.document.case_number||"",score:e.score||0,chunk_index:0,created_at:e.document.created_at});return console.log(`Found ${l.length} similar cases for query: "${e.substring(0,50)}..."`),l}catch(e){return console.error("Vector search failed:",e),[]}}async searchKnowledgeBase(e,t={}){return this.searchSimilarCases(e,{...t})}}function i(){let e=process.env.AZURE_SEARCH_ENDPOINT,t=process.env.AZURE_SEARCH_KEY,s=process.env.AZURE_SEARCH_INDEX_NAME,n=process.env.OPENAI_API_KEY,a=process.env.CASE_EMBEDDING_MODEL||"text-embedding-3-small";return e&&t&&s&&n?new r(e,t,s,n,a):(console.warn("Azure Search is not configured. Missing required environment variables."),null)}},23271:(e,t,s)=>{"use strict";s.d(t,{X:()=>r});var n=s(86632);class a{static{this.STATIC_CLIENTS=[{entityName:"Altus Community Healthcare",entityType:"CLIENT",industry:"Healthcare",description:"Managed services client operating healthcare facilities",aliases:["Altus","Altus Health","Altus Healthcare"],relatedEntities:[],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]},{entityName:"Neighbors Emergency Center",entityType:"CLIENT",industry:"Healthcare",description:"Emergency room and urgent care provider",aliases:["Neighbors ER","Neighbors"],relatedEntities:[],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]},{entityName:"FPA Women's Health",entityType:"CLIENT",industry:"Healthcare",description:"Women's health medical services provider",aliases:["FPA"],relatedEntities:[],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]}]}static{this.STATIC_VENDORS=[{entityName:"Microsoft",entityType:"VENDOR",industry:"Software",description:"Office 365, Teams, Azure cloud services vendor",aliases:["MS","MSFT"],relatedEntities:["Azure","Office 365","Teams"],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]},{entityName:"Fortinet",entityType:"VENDOR",industry:"Networking",description:"Firewall and network security hardware/software vendor",aliases:[],relatedEntities:["FortiGate"],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]},{entityName:"Palo Alto Networks",entityType:"VENDOR",industry:"Security",description:"Network security and firewall vendor",aliases:["Palo Alto","PA"],relatedEntities:[],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]}]}static{this.STATIC_PLATFORMS=[{entityName:"Azure",entityType:"PLATFORM",industry:"Cloud",description:"Microsoft cloud computing platform",aliases:["Azure Cloud","Microsoft Azure"],relatedEntities:["Microsoft"],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]},{entityName:"ServiceNow",entityType:"PLATFORM",industry:"ITSM",description:"IT service management platform",aliases:["SNOW"],relatedEntities:[],keyContacts:[],slackChannels:[],cmdbIdentifiers:[],contextStewards:[]}]}constructor(){this.repository=(0,n.getBusinessContextRepository)(),this.contextCache=new Map,this.loadStaticContext()}buildContextFromDbRecord(e){return{entityName:e.entityName,entityType:e.entityType,industry:e.industry||void 0,description:e.description||void 0,aliases:e.aliases||[],relatedEntities:e.relatedEntities||[],technologyPortfolio:e.technologyPortfolio||void 0,serviceDetails:e.serviceDetails||void 0,keyContacts:e.keyContacts||[],slackChannels:e.slackChannels||[],cmdbIdentifiers:e.cmdbIdentifiers||[],contextStewards:e.contextStewards||[]}}storeContextInCache(e){for(let t of[e.entityName,...e.aliases].map(e=>e.toLowerCase().trim()))this.contextCache.set(t,e)}removeContextFromCache(e){let t=e.toLowerCase().trim();for(let[e,s]of this.contextCache.entries())(e===t||s.entityName.toLowerCase()===t)&&this.contextCache.delete(e)}loadStaticContext(){for(let e of[...a.STATIC_CLIENTS,...a.STATIC_VENDORS,...a.STATIC_PLATFORMS])for(let t of[e.entityName,...e.aliases])this.contextCache.set(t.toLowerCase(),e)}async getContextForCompany(e){if(!e)return null;let t=e.toLowerCase().trim();if(this.contextCache.has(t))return this.contextCache.get(t);try{let t=await this.repository.findByNameOrAlias(e);if(t){console.log(`‚úÖ [Business Context] Loaded from database: ${e}`);let s=this.buildContextFromDbRecord(t);return this.storeContextInCache(s),s}}catch(t){console.warn(`[Business Context] Database lookup failed for "${e}":`,t)}return null}async refreshContext(e){try{let t=await this.repository.findByName(e);if(!t)return this.removeContextFromCache(e),null;let s=this.buildContextFromDbRecord(t);return this.removeContextFromCache(e),this.storeContextInCache(s),s}catch(t){return console.warn(`[Business Context] Failed to refresh context for "${e}":`,t),null}}toPromptText(e){let t=[`‚Ä¢ ${e.entityName}`];if(e.entityType&&t.push(`(${e.entityType})`),e.industry&&t.push(`- ${e.industry} industry`),e.description&&t.push(`
  ${e.description}`),e.aliases.length>0){let s=e.aliases.slice(0,3).join(", ");t.push(`
  Also known as: ${s}`)}if(e.technologyPortfolio&&t.push(`
  Technology: ${e.technologyPortfolio}`),e.serviceDetails&&t.push(`
  Services: ${e.serviceDetails}`),e.keyContacts.length>0){let s=e.keyContacts.slice(0,2).map(e=>`${e.name} (${e.role})`).join(", ");t.push(`
  Key contacts: ${s}`)}if(e.slackChannels.length>0){let s=e.slackChannels.map(e=>e.notes?`#${e.name} (${e.notes})`:`#${e.name}`).join(", ");t.push(`
  Slack channels: ${s}`)}if(e.cmdbIdentifiers.length>0){let s=e.cmdbIdentifiers.slice(0,2).map(e=>{let t=e.ciName||e.sysId||"Unknown CI",s=e.ipAddresses?.length?` [IP: ${e.ipAddresses.join(", ")}]`:"",n=e.ownerGroup?` Owner: ${e.ownerGroup}.`:"",a=e.description?` ${e.description}`:"";return`${t}${s}.${n}${a}`.trim()});t.push(`
  CMDB refs: ${s.join(" | ")}`)}if(e.contextStewards.length>0){let s=e.contextStewards.map(e=>e.name||e.id||e.type).join(", ");t.push(`
  Context stewards: ${s}`)}return t.join(" ")}buildClassificationRules(){let e=[];for(let t of(e.push("--- BUSINESS CONTEXT & CLASSIFICATION RULES ---"),e.push(""),e.push("CRITICAL: Understand the difference between OUR CLIENTS vs VENDORS:"),e.push(""),e.push("**OUR CLIENTS** (companies we provide managed services to):"),a.STATIC_CLIENTS))e.push(`  ${this.toPromptText(t)}`);for(let t of(e.push(""),e.push("**VENDORS** (software/hardware providers we use):"),a.STATIC_VENDORS))e.push(`  ${this.toPromptText(t)}`);for(let t of(e.push(""),e.push("**PLATFORMS** (cloud/software platforms):"),a.STATIC_PLATFORMS))e.push(`  ${this.toPromptText(t)}`);return e.push(""),e.join("\n")}async enhancePromptWithContext(e,t,s,n){let a=[];if(a.push("--- BUSINESS CONTEXT ---"),a.push("We (Mobiz IT) are a consulting and Managed Service Provider."),a.push(""),s&&a.push(`Channel topic: ${s}`),n&&a.push(`Channel purpose: ${n}`),(s||n)&&a.push(""),t){let e=await this.getContextForCompany(t);if(e){if(console.log(`üìã [Business Context] Enhancing prompt with context for "${t}"`),a.push(`Company in this case: ${t}`),a.push(`- Type: ${e.entityType}`),e.industry&&a.push(`- Industry: ${e.industry}`),e.description&&a.push(`- Description: ${e.description}`),e.aliases.length>0){let t=e.aliases.slice(0,3).join(", ");a.push(`- Also known as: ${t}`)}if(e.relatedEntities.length>0){let t=e.relatedEntities.slice(0,3).join(", ");a.push(`- Related entities: ${t}`)}if(e.technologyPortfolio&&a.push(`- Technology: ${e.technologyPortfolio}`),e.serviceDetails&&a.push(`- Service info: ${e.serviceDetails}`),e.keyContacts.length>0){let t=e.keyContacts.slice(0,2).map(e=>`${e.name} (${e.role})`).join(", ");a.push(`- Key contacts: ${t}`)}if(e.slackChannels.length>0){let t=e.slackChannels.map(e=>e.notes?`#${e.name} (${e.notes})`:`#${e.name}`).join(", ");a.push(`- Slack channels: ${t}`)}if(e.cmdbIdentifiers.length>0){let t=e.cmdbIdentifiers.slice(0,2).map(e=>{let t=e.ciName||e.sysId||"Unknown CI",s=e.ipAddresses?.length?` IP: ${e.ipAddresses.join(", ")}`:"",n=e.documentation?.length?` Docs: ${e.documentation.join("; ")}`:"";return`${t}${s}${n}`.trim()}).join(" | ");a.push(`- CMDB references: ${t}`)}if(e.contextStewards.length>0){let t=e.contextStewards.map(e=>{let t=e.name||e.id||e.type;return e.notes?`${t} (${e.notes})`:t}).join(", ");a.push(`- Context stewards: ${t}`)}a.push("")}else console.log(`‚ö†Ô∏è  [Business Context] No context found for company "${t}"`)}let o=a.join("\n");return`${o}

${e}`}getAllClientNames(){return a.STATIC_CLIENTS.map(e=>e.entityName)}getAllVendorNames(){return a.STATIC_VENDORS.map(e=>e.entityName)}}let o=null;function r(){return o||(o=new a),o}},45540:(e,t,s)=>{"use strict";s.d(t,{F:()=>o});var n=s(27467);let a=new Map;async function o(e){if(a.has(e))return a.get(e);try{let t=await n.Lp.conversations.info({channel:e});if(!t.channel)return console.warn(`No channel info found for ${e}`),null;let s=t.channel.name||e,o=t.channel.topic?.value||void 0,r=t.channel.purpose?.value||void 0,i=function(e){if(!e)return;let t=e.toLowerCase(),s=["general","random","help","support","helpdesk","tickets","cases","tech-support","it-support"];if(s.includes(t))return;let n=t.split(/[-_]/);if(n.length>=2){let e=n[0];if(!s.includes(e)&&e.length>2)return e}}(s),l={channelId:e,channelName:s,channelTopic:o,channelPurpose:r,potentialCustomer:i};return a.set(e,l),l}catch(t){return console.error(`Error fetching channel info for ${e}:`,t),null}}},44380:(e,t,s)=>{"use strict";s.d(t,{B:()=>p});var n=s(96353),a=s(51362),o=s(5079),r=s(5028),i=s(23271),l=s(90916),c=s(39045);let d=o.Ry({title:o.Z_().min(10).max(120),problem:o.Z_().min(10),environment:o.Z_().min(5),solution:o.Z_().min(10),rootCause:o.Z_().min(5).optional(),relatedCases:o.IX(o.Z_()).max(10),tags:o.IX(o.Z_().min(2)).max(10),conversationSummary:o.Z_().optional()}),u=(0,n.w3)({description:"Return the fully structured knowledge base article as your final output. Call this exactly once.",inputSchema:d,execute:async e=>e});class h{async generateArticle(e,t){let s=e.messages.map(e=>e.text).join("\n"),n=await this.findSimilarKBs(s);if(n.length>0&&n[0].score>.85)return{article:null,similarExistingKBs:n,isDuplicate:!0,confidence:0};let a=await this.generateWithLLM(e,t,n),o=this.calculateConfidence(e,a);return{article:a,similarExistingKBs:n,isDuplicate:!1,confidence:o}}async findSimilarKBs(e){if(!this.azureSearch)return[];try{return(await this.azureSearch.searchKnowledgeBase(e,{topK:c.v.kbSimilarCasesTopK})).map(e=>({case_number:e.case_number,content:e.content,score:e.score}))}catch(e){return console.error("Error searching similar KBs:",e),[]}}async generateWithLLM(e,t,s){let n=e.messages.map(e=>`${e.user}: ${e.text}`).join("\n"),o=s.length>0?`

Similar resolved cases for reference:
${s.map(e=>`- ${e.case_number}: ${e.content.substring(0,200)}...`).join("\n")}`:"",r=`You are a technical documentation expert creating a knowledge base article from a support case resolution.

Case Number: ${e.caseNumber}
${t?`Case Details: ${JSON.stringify(t,null,2)}`:""}

Conversation that led to resolution:
${n}
${o}

When you have finished analysing the conversation, call the \`draft_kb_article\` tool exactly once with:
- title: clear descriptive title (50-80 characters)
- problem: precise summary of symptoms/impact
- environment: relevant systems, versions, configs
- solution: step-by-step resolution in markdown (numbered steps where possible)
- rootCause: why it happened if identified (omit otherwise)
- relatedCases: case numbers referenced in the conversation
- tags: relevant keywords (technology, component, issue type)
- conversationSummary: concise recap of the resolution dialogue

Ensure accuracy, avoid assumptions, and keep the solution actionable.`;try{let t=(0,i.X)(),s=await t.enhancePromptWithContext(r,e.channelName,e.channelTopic,e.channelPurpose),o=(await (0,a._4)({model:l.Q.languageModel("kb-generator"),system:"You are a meticulous knowledge base author. You MUST call the `draft_kb_article` tool exactly once with your final structured article.",prompt:s,tools:{draft_kb_article:u},toolChoice:{type:"tool",toolName:"draft_kb_article"}})).toolResults[0];if(!o||"tool-result"!==o.type)throw Error("Model did not return structured KB article data");let c=d.parse(o.output);return{...c,conversationSummary:c.conversationSummary??n}}catch(s){return console.error("Error generating KB with LLM:",s),this.createFallbackArticle(e,t)}}createFallbackArticle(e,t){let s=e.messages.map(e=>`${e.user}: ${e.text}`).join("\n");return{title:`Resolution for ${e.caseNumber}`,problem:t?.short_description||"Issue details from conversation",environment:"See conversation details",solution:s,rootCause:"See conversation for analysis",relatedCases:[e.caseNumber],tags:["needs-review"],conversationSummary:s}}calculateConfidence(e,t){let s=0;return e.messages.length>=5?s+=30:e.messages.length>=3?s+=20:s+=10,t.solution.length>200?s+=25:t.solution.length>100?s+=15:s+=5,t.environment&&t.environment.length>20&&(s+=15),t.rootCause&&t.rootCause.length>20&&(s+=15),t.tags.length>=3?s+=15:t.tags.length>=1&&(s+=10),Math.min(s,100)}formatForSlack(e){let t=`üìö *Knowledge Base Article Draft*

`;return t+=`*Title:* ${e.title}

*Problem:*
${e.problem}

`,e.environment&&(t+=`*Environment:*
${e.environment}

`),t+=`*Solution:*
${e.solution}

`,e.rootCause&&(t+=`*Root Cause:*
${e.rootCause}

`),e.relatedCases.length>0&&(t+=`*Related Cases:* ${e.relatedCases.join(", ")}

`),e.tags.length>0&&(t+=`*Tags:* ${e.tags.join(", ")}
`),t}formatSimilarKBsWarning(e){let t=`‚ö†Ô∏è *Similar KB Articles Found*

`;return t+=`This issue may already be documented:

`,e.slice(0,3).forEach((e,s)=>{let n=e.content.substring(0,150);t+=`${s+1}. *${e.case_number}* (${(100*e.score).toFixed(0)}% match)
   ${n}${e.content.length>150?"...":""}

`}),t+="_Consider updating an existing article instead of creating a new one._"}constructor(){this.azureSearch=(0,r.n)()}}let m=null;function p(){return m||(m=new h),m}},7644:(e,t,s)=>{"use strict";s.d(t,{zC:()=>n,hm:()=>h});var n,a=s(30513),o=s(51921),r=s(19954);class i{async saveState(e){let t=(0,o.zA)();if(t)try{await t.insert(r.kbGenerationStates).values({caseNumber:e.caseNumber,threadTs:e.threadTs,channelId:e.channelId,state:e.state,attemptCount:e.attemptCount,userResponses:e.userResponses,assessmentScore:e.assessmentScore,missingInfo:e.missingInfo||[],startedAt:e.startedAt,lastUpdated:e.lastUpdated}).onConflictDoUpdate({target:[r.kbGenerationStates.caseNumber,r.kbGenerationStates.threadTs],set:{channelId:e.channelId,state:e.state,attemptCount:e.attemptCount,userResponses:e.userResponses,assessmentScore:e.assessmentScore,missingInfo:e.missingInfo||[],lastUpdated:e.lastUpdated}}),console.log(`[DB] Saved KB state for ${e.caseNumber}: ${e.state}`)}catch(t){console.error(`[DB] Error saving KB state for ${e.caseNumber}:`,t)}}async loadState(e,t){let s=(0,o.zA)();if(!s)return null;try{let n=await s.select().from(r.kbGenerationStates).where((0,a.xD)((0,a.eq)(r.kbGenerationStates.caseNumber,e),(0,a.eq)(r.kbGenerationStates.threadTs,t))).limit(1);if(0===n.length)return null;let o=n[0],i={caseNumber:o.caseNumber,threadTs:o.threadTs,channelId:o.channelId,state:o.state,attemptCount:o.attemptCount,userResponses:o.userResponses,assessmentScore:o.assessmentScore||void 0,missingInfo:o.missingInfo||void 0,startedAt:o.startedAt,lastUpdated:o.lastUpdated};return console.log(`[DB] Loaded KB state for ${e}: ${i.state}`),i}catch(t){return console.error(`[DB] Error loading KB state for ${e}:`,t),null}}async loadActiveGatheringStates(){let e=(0,o.zA)();if(!e)return[];try{let t=(await e.select().from(r.kbGenerationStates).where((0,a.eq)(r.kbGenerationStates.state,"gathering"))).map(e=>({caseNumber:e.caseNumber,threadTs:e.threadTs,channelId:e.channelId,state:e.state,attemptCount:e.attemptCount,userResponses:e.userResponses,assessmentScore:e.assessmentScore||void 0,missingInfo:e.missingInfo||void 0,startedAt:e.startedAt,lastUpdated:e.lastUpdated}));return console.log(`[DB] Loaded ${t.length} active gathering states`),t}catch(e){return console.error("[DB] Error loading active gathering states:",e),[]}}async loadAllActiveStates(){let e=(0,o.zA)();if(!e)return[];try{let t=(await e.select().from(r.kbGenerationStates).where((0,a.xD)((0,a.ne)(r.kbGenerationStates.state,"abandoned"),(0,a.ne)(r.kbGenerationStates.state,"approved"),(0,a.ne)(r.kbGenerationStates.state,"rejected")))).map(e=>({caseNumber:e.caseNumber,threadTs:e.threadTs,channelId:e.channelId,state:e.state,attemptCount:e.attemptCount,userResponses:e.userResponses,assessmentScore:e.assessmentScore||void 0,missingInfo:e.missingInfo||void 0,startedAt:e.startedAt,lastUpdated:e.lastUpdated}));return console.log(`[DB] Loaded ${t.length} active KB generation states`),t}catch(e){return console.error("[DB] Error loading active states:",e),[]}}async deleteState(e,t){let s=(0,o.zA)();if(s)try{await s.delete(r.kbGenerationStates).where((0,a.xD)((0,a.eq)(r.kbGenerationStates.caseNumber,e),(0,a.eq)(r.kbGenerationStates.threadTs,t))),console.log(`[DB] Deleted KB state for ${e}`)}catch(t){console.error(`[DB] Error deleting KB state for ${e}:`,t)}}async cleanupExpiredStates(e){let t=(0,o.zA)();if(!t)return 0;try{let s=new Date;s.setHours(s.getHours()-e);let n=(await t.delete(r.kbGenerationStates).where((0,a.xD)((0,a.eq)(r.kbGenerationStates.state,"gathering"),(0,a.lt)(r.kbGenerationStates.lastUpdated,s)))).rowCount||0;return console.log(`[DB] Cleaned up ${n} expired KB states`),n}catch(e){return console.error("[DB] Error cleaning up expired states:",e),0}}}let l=null;var c=s(39045);!function(e){e.ASSESSING="assessing",e.GATHERING="gathering",e.GENERATING="generating",e.PENDING_APPROVAL="pending_approval",e.APPROVED="approved",e.REJECTED="rejected",e.AWAITING_NOTES="awaiting_notes",e.ABANDONED="abandoned"}(n||(n={}));class d{constructor(e){this.contexts=new Map,this.maxAttempts=c.v.kbGatheringMaxAttempts,this.timeoutHours=c.v.kbGatheringTimeoutHours,this.repository=e||(l||(l=new i),l)}initialize(e,t,s){let n=this.getKey(e,t),a={caseNumber:e,threadTs:t,channelId:s,state:"assessing",startedAt:new Date,lastUpdated:new Date,attemptCount:0,userResponses:[]};this.contexts.set(n,a),this.repository.saveState(a).catch(e=>{console.error("[KB State] Failed to save initial state:",e)}),console.log(`[KB State] Initialized for ${e} in state ASSESSING`)}setState(e,t,s){let n=this.getKey(e,t),a=this.contexts.get(n);if(!a){console.warn(`[KB State] No context found for ${e}, creating new one`),this.initialize(e,t,"");return}let o=a.state;a.state=s,a.lastUpdated=new Date,this.repository.saveState(a).catch(e=>{console.error("[KB State] Failed to save state update:",e)}),console.log(`[KB State] ${e}: ${o} ‚Üí ${s}`)}getState(e,t){let s=this.getKey(e,t);return this.contexts.get(s)?.state||null}getContext(e,t){let s=this.getKey(e,t);return this.contexts.get(s)||null}isWaitingForUser(e,t){return"gathering"===this.getState(e,t)}addUserResponse(e,t,s){let n=this.getKey(e,t),a=this.contexts.get(n);if(!a){console.warn(`[KB State] Cannot add response, no context for ${e}`);return}a.userResponses.push(s),a.lastUpdated=new Date,this.repository.saveState(a).catch(e=>{console.error("[KB State] Failed to save user response:",e)}),console.log(`[KB State] Added user response for ${e} (${a.userResponses.length} total)`)}incrementAttempt(e,t){let s=this.getKey(e,t),n=this.contexts.get(s);return n?(n.attemptCount+=1,n.lastUpdated=new Date,this.repository.saveState(n).catch(e=>{console.error("[KB State] Failed to save attempt count:",e)}),console.log(`[KB State] Attempt ${n.attemptCount}/${this.maxAttempts} for ${e}`),n.attemptCount):(console.warn(`[KB State] Cannot increment attempt, no context for ${e}`),0)}hasReachedMaxAttempts(e,t){let s=this.getContext(e,t);return(s?.attemptCount||0)>=this.maxAttempts}storeAssessment(e,t,s,n){let a=this.getKey(e,t),o=this.contexts.get(a);o&&(o.assessmentScore=s,o.missingInfo=n,o.lastUpdated=new Date,this.repository.saveState(o).catch(e=>{console.error("[KB State] Failed to save assessment:",e)}))}remove(e,t){let s=this.getKey(e,t);this.contexts.delete(s),this.repository.deleteState(e,t).catch(e=>{console.error("[KB State] Failed to delete state from database:",e)}),console.log(`[KB State] Removed context for ${e}`)}async loadFromDatabase(){try{console.log("[KB State] Loading states from database...");let e=await this.repository.loadAllActiveStates();for(let t of e){let e=this.getKey(t.caseNumber,t.threadTs);this.contexts.set(e,t)}console.log(`[KB State] Loaded ${e.length} states from database`)}catch(e){console.error("[KB State] Error loading states from database:",e)}}async cleanupExpired(){let e=new Date().getTime()-36e5*this.timeoutHours,t=0;for(let[s,n]of this.contexts.entries())"gathering"===n.state&&n.lastUpdated.getTime()<e&&(console.log(`[KB State] Cleaning up expired context for ${n.caseNumber}`),this.contexts.delete(s),t++);try{let e=await this.repository.cleanupExpiredStates(this.timeoutHours);console.log(`[KB State] Cleaned up ${t} from memory, ${e} from database`)}catch(e){console.error("[KB State] Error cleaning up database:",e)}return t>0&&console.log(`[KB State] Cleaned up ${t} expired contexts from memory`),t}getContextsInState(e){return Array.from(this.contexts.values()).filter(t=>t.state===e)}getStats(){let e=Array.from(this.contexts.values());return{total:e.length,assessing:e.filter(e=>"assessing"===e.state).length,gathering:e.filter(e=>"gathering"===e.state).length,generating:e.filter(e=>"generating"===e.state).length,pendingApproval:e.filter(e=>"pending_approval"===e.state).length}}getKey(e,t){return`${e}:${t}`}}let u=null;function h(){return u||(u=new d,setInterval(()=>{u?.cleanupExpired()},36e5)),u}},27467:(e,t,s)=>{"use strict";s.d(t,{Cc:()=>h,JN:()=>d,Lp:()=>i,bJ:()=>u,mA:()=>c});var n=s(23859),a=s(84770),o=s.n(a);let r=process.env.SLACK_SIGNING_SECRET,i=new n.WebClient(process.env.SLACK_BOT_TOKEN);async function l({request:e,rawBody:t}){let s=e.headers.get("X-Slack-Request-Timestamp"),n=e.headers.get("X-Slack-Signature");if(!s||!n)return console.log("Missing timestamp or signature"),!1;if(Math.abs(Date.now()/1e3-parseInt(s))>300)return console.log("Timestamp out of range"),!1;let a=`v0:${s}:${t}`,i=o().createHmac("sha256",r).update(a).digest("hex"),l=`v0=${i}`;return o().timingSafeEqual(Buffer.from(l),Buffer.from(n))}let c=async({requestType:e,request:t,rawBody:s})=>{if(!await l({request:t,rawBody:s})||"event_callback"!==e)return new Response("Invalid request",{status:400})},d=(e,t)=>{let s=!0;return async n=>{if(s)try{await i.assistant.threads.setStatus({channel_id:e,thread_ts:t,status:n})}catch(n){let e="object"==typeof n&&null!==n?n:null,t=String(e?.data?.error??e?.message??"");if("missing_scope"===t||"method_not_supported_for_channel_type"===t||t.includes("missing_scope")||t.includes("method_not_supported_for_channel_type")){s=!1,console.warn("Disabling assistant thread status updates",t);return}throw n}}};async function u(e,t,s){let{messages:n}=await i.conversations.replies({channel:e,ts:t,limit:50});if(!n)throw Error("No messages found in thread");return n.map(e=>{let t=!!e.bot_id;if(!e.text)return null;let n=e.text;return!t&&n.includes(`<@${s}>`)&&(n=n.replace(`<@${s}> `,"")),{role:t?"assistant":"user",content:n}}).filter(e=>null!==e)}let h=async()=>{let{user_id:e}=await i.auth.test();if(!e)throw Error("botUserId is undefined");return e}},37929:(e,t,s)=>{"use strict";s.d(t,{K:()=>d});var n=s(72254);let a={instanceUrl:process.env.SERVICENOW_INSTANCE_URL||process.env.SERVICENOW_URL,username:process.env.SERVICENOW_USERNAME,password:process.env.SERVICENOW_PASSWORD,apiToken:process.env.SERVICENOW_API_TOKEN,caseTable:process.env.SERVICENOW_CASE_TABLE?.trim()||"sn_customerservice_case",caseJournalName:process.env.SERVICENOW_CASE_JOURNAL_NAME?.trim()||"x_mobit_serv_case_service_case",ciTable:process.env.SERVICENOW_CI_TABLE?.trim()||"cmdb_ci"};function o(){return a.username&&a.password?"basic":a.apiToken?"token":null}async function r(){let e=o();if("basic"===e){let e=n.Buffer.from(`${a.username}:${a.password}`).toString("base64");return{Authorization:`Basic ${e}`}}if("token"===e)return{Authorization:`Bearer ${a.apiToken}`};throw Error("ServiceNow credentials are not configured. Set SERVICENOW_USERNAME/PASSWORD or SERVICENOW_API_TOKEN.")}async function i(e,t={}){if(!a.instanceUrl)throw Error("ServiceNow instance URL is not configured. Set SERVICENOW_INSTANCE_URL.");let s={"content-type":"application/json",...t.headers??{},...await r()},n=await fetch(`${a.instanceUrl}${e}`,{...t,headers:s});if(!n.ok){let e=await n.text();throw Error(`ServiceNow request failed with status ${n.status}: ${e.slice(0,500)}`)}return await n.json()}function l(e){return e?"string"==typeof e?e:"object"==typeof e&&e.display_value?e.display_value:"object"==typeof e&&e.value?e.value:String(e):""}class c{isConfigured(){return!!(a.instanceUrl&&o())}async getIncident(e){let t=await i(`/api/now/table/incident?number=${encodeURIComponent(e)}`);if(!t.result?.length)return null;let s=t.result[0];return{...s,url:`${a.instanceUrl}/nav_to.do?uri=incident.do?sys_id=${s.sys_id}`}}async searchKnowledge(e){let t=e.limit??3;return(await i(`/api/now/table/kb_knowledge?sysparm_query=ORDERBYDESCsys_updated_on^textLIKE${encodeURIComponent(e.query)}&sysparm_limit=${t}`)).result.map(e=>({...e,url:`${a.instanceUrl}/nav_to.do?uri=kb_knowledge.do?sys_id=${e.sys_id}`}))}async getCase(e){let t=a.caseTable??"sn_customerservice_case",s=await i(`/api/now/table/${t}?sysparm_query=${encodeURIComponent(`number=${e}`)}&sysparm_limit=1&sysparm_display_value=all`);if(!s.result?.length)return null;let n=s.result[0],o=l(n.sys_id),r=l(n.opened_by),c=l(n.caller_id);return{sys_id:o,number:n.number,short_description:l(n.short_description),description:l(n.description),priority:l(n.priority),state:l(n.state),category:l(n.category),subcategory:l(n.subcategory),opened_at:l(n.opened_at),assignment_group:l(n.assignment_group),assigned_to:l(n.assigned_to),opened_by:r,caller_id:c,submitted_by:l(n.submitted_by)||r||c||void 0,url:`${a.instanceUrl}/nav_to.do?uri=${t}.do?sys_id=${o}`}}async getCaseJournal(e,{limit:t=20}={}){let s=a.caseJournalName,n=[`element_id=${e}`];s&&n.push(`name=${s}`);let o=`${n.join("^")}^ORDERBYDESCsys_created_on`;return(await i(`/api/now/table/sys_journal_field?sysparm_query=${encodeURIComponent(o)}&sysparm_limit=${t}&sysparm_fields=${encodeURIComponent("sys_id,element,element_id,name,sys_created_on,sys_created_by,value")}`)).result??[]}async searchConfigurationItems(e){let t=a.ciTable??"cmdb_ci",s=e.limit??5,n=[];if(e.sysId&&n.push(`sys_id=${e.sysId}`),e.name){let t=e.name.trim();t&&n.push(`nameLIKE${t}^ORfqdnLIKE${t}^ORu_fqdnLIKE${t}^ORhost_nameLIKE${t}`)}if(e.ipAddress){let t=e.ipAddress.trim();t&&n.push(`ip_addressLIKE${t}^ORu_ip_addressLIKE${t}^ORfqdnLIKE${t}`)}if(!n.length)throw Error("Provide at least one of: name, ipAddress, or sysId to search configuration items.");let o=n.join("^");return((await i(`/api/now/table/${t}?sysparm_query=${encodeURIComponent(o)}&sysparm_display_value=all&sysparm_limit=${s}`)).result??[]).map(e=>{let s=l(e.sys_id),n=l(e.name)||l(e.fqdn)||l(e.u_fqdn)||l(e.host_name)||s;return{sys_id:s,name:n,sys_class_name:l(e.sys_class_name)||void 0,fqdn:l(e.fqdn)||l(e.u_fqdn)||void 0,host_name:l(e.host_name)||void 0,ip_addresses:function(e){if(!e)return[];if(Array.isArray(e))return e.map(e=>l(e)).map(e=>e.trim()).filter(e=>!!e);let t=l(e);return t?t.split(/[\s,;]+/).map(e=>e.trim()).filter(e=>!!e):[]}(e.ip_address??e.u_ip_address),owner_group:l(e.owner)||l(e.support_group)||void 0,support_group:l(e.support_group)||void 0,location:l(e.location)||void 0,environment:l(e.u_environment)||void 0,status:l(e.install_status)||l(e.status)||void 0,description:l(e.short_description)||l(e.description)||void 0,url:`${a.instanceUrl}/nav_to.do?uri=${t}.do?sys_id=${s}`}})}async searchCustomerCases(e){let t=a.caseTable??"sn_customerservice_case",s=e.limit??5,n=["ORDERBYDESCopened_at"];e.accountName&&n.push(`account.nameLIKE${e.accountName}`),e.companyName&&n.push(`company.nameLIKE${e.companyName}`),e.query&&n.push(`short_descriptionLIKE${e.query}`),e.activeOnly&&n.push("active=true");let o=n.join("^");return((await i(`/api/now/table/${t}?sysparm_query=${encodeURIComponent(o)}&sysparm_display_value=all&sysparm_limit=${s}`)).result??[]).map(e=>{let s=l(e.sys_id);return{sys_id:s,number:l(e.number),short_description:l(e.short_description)||void 0,priority:l(e.priority)||void 0,state:l(e.state)||void 0,account:l(e.account)||void 0,company:l(e.company)||void 0,opened_at:l(e.opened_at)||void 0,updated_on:l(e.sys_updated_on)||void 0,url:`${a.instanceUrl}/nav_to.do?uri=${t}.do?sys_id=${s}`}})}}let d=new c}};