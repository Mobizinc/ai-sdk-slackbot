(()=>{var e={};e.id=715,e.ids=[715],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},55315:e=>{"use strict";e.exports=require("path")},76162:e=>{"use strict";e.exports=require("stream")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},87561:e=>{"use strict";e.exports=require("node:fs")},70612:e=>{"use strict";e.exports=require("node:os")},49411:e=>{"use strict";e.exports=require("node:path")},39630:e=>{"use strict";e.exports=require("node:querystring")},84492:e=>{"use strict";e.exports=require("node:stream")},47261:e=>{"use strict";e.exports=require("node:util")},65628:e=>{"use strict";e.exports=require("node:zlib")},57943:()=>{},68503:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>w,requestAsyncStorage:()=>b,routeModule:()=>x,serverHooks:()=>q,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{GET:()=>_,POST:()=>y});var a=r(35847),n=r(67605),o=r(52520),i=r(5079),u=r(10827),l=r(27467),c=r(84770),p=r.n(c);let d=i.Ry({channel:i.Z_().min(1,"target.channel is required").optional(),user:i.Z_().min(1,"target.user cannot be empty").optional(),thread_ts:i.Z_().min(1,"target.thread_ts cannot be empty").optional(),reply_broadcast:i.O7().optional()}).superRefine((e,t)=>{e.channel||e.user||t.addIssue({code:u.NL.custom,message:"Provide either target.channel or target.user",path:["channel"]})}),m=i.Ry({text:i.Z_().optional(),blocks:i.IX(i._4()).optional(),attachments:i.IX(i._4()).optional(),unfurl_links:i.O7().optional(),unfurl_media:i.O7().optional()}).superRefine((e,t)=>{let r=e.text?.trim();r||e.blocks||t.addIssue({code:u.NL.custom,message:"message.text or message.blocks is required",path:["text"]}),"string"==typeof e.text&&r?.length===0&&t.addIssue({code:u.NL.custom,message:"message.text cannot be empty",path:["text"]})}),h=i.Ry({correlationId:i.Z_().max(128).optional(),eventType:i.Z_().max(64).optional(),payload:i.IM(i._4()).optional()}).optional(),f=i.Ry({target:d,message:m,source:i.Z_().max(128).optional(),metadata:h});function g(e,t=200,r){return new Response(JSON.stringify(e),{status:t,headers:{"content-type":"application/json",...r??{}}})}async function y(e){let t;let r=await e.text(),s=function({headers:e,rawBody:t,toleranceSeconds:r=300}){let s=function(){let e=process.env.RELAY_WEBHOOK_SECRET;return e&&0!==e.trim().length?e:null}();if(!s)return{ok:!1,status:500,message:"Relay webhook secret is not configured"};let a=e.get("x-relay-signature"),n=e.get("x-relay-timestamp");if(!a||!n)return{ok:!1,status:401,message:"Missing relay signature headers"};let o=Number(n);if(!Number.isFinite(o))return{ok:!1,status:400,message:"Invalid relay timestamp header"};if(Math.abs(Math.floor(Date.now()/1e3)-o)>r)return{ok:!1,status:401,message:"Relay request timestamp outside allowable window"};let i=`v1:${o}:${t}`,u=p().createHmac("sha256",s).update(i).digest("hex"),l=`v1=${u}`,c=Buffer.from(l,"utf8"),d=Buffer.from(a,"utf8");return c.length===d.length&&p().timingSafeEqual(c,d)?{ok:!0,timestamp:o}:{ok:!1,status:401,message:"Relay signature mismatch"}}({headers:e.headers,rawBody:r});if(!s.ok)return g({error:s.message},s.status);try{t=JSON.parse(r)}catch{return g({error:"Request body must be valid JSON"},400)}let a=f.safeParse(t);if(!a.success)return g({error:"Invalid relay payload",details:a.error.flatten()},400);let{target:n,message:o,metadata:i,source:u}=a.data,c=n.channel,d=n.thread_ts;try{if(!c&&n.user){let e=await l.Lp.conversations.open({users:n.user});if(!(c=e.channel?.id??void 0))return g({error:"Unable to open conversation for target.user"},404)}if(!c)return g({error:"Unable to resolve target channel"},400);let e=o.text?.trim(),t={channel:c,text:e??(u?`Relay from ${u}`:"Relay message"),unfurl_links:o.unfurl_links,unfurl_media:o.unfurl_media};if(d&&(t.thread_ts=d),!0===n.reply_broadcast&&(t.reply_broadcast=!0),o.blocks&&(t.blocks=o.blocks),o.attachments&&(t.attachments=o.attachments),i||u){let e=i?.eventType??"relay.message",r={...i?.payload??{},...i?.correlationId?{correlationId:i.correlationId}:{},...u?{source:u}:{}};t.metadata={event_type:e,event_payload:r}}let r=await l.Lp.chat.postMessage(t);if(!r.ok){let e=r.error??"Slack did not accept the message";return g({error:e},502)}return d||(d=r.ts??void 0),g({ok:!0,channel:r.channel??c,ts:r.ts,thread_ts:d},200)}catch(e){return console.error("Failed to relay message",e),g({error:"Failed to relay message"},502)}}async function _(){return g({message:"Relay endpoint expects authenticated POST requests"},405,{allow:"POST"})}let x=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/relay/route",pathname:"/api/relay",filename:"route",bundlePath:"app/api/relay/route"},resolvedPagePath:"/Users/hamadriaz/Documents/codebase/ai-sdk-slackbot/app/api/relay/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:b,staticGenerationAsyncStorage:v,serverHooks:q}=x,k="/api/relay/route";function w(){return(0,o.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:v})}},27467:(e,t,r)=>{"use strict";r.d(t,{Cc:()=>d,JN:()=>c,Lp:()=>i,bJ:()=>p,mA:()=>l});var s=r(23859),a=r(84770),n=r.n(a);let o=process.env.SLACK_SIGNING_SECRET,i=new s.WebClient(process.env.SLACK_BOT_TOKEN);async function u({request:e,rawBody:t}){let r=e.headers.get("X-Slack-Request-Timestamp"),s=e.headers.get("X-Slack-Signature");if(!r||!s)return console.log("Missing timestamp or signature"),!1;if(Math.abs(Date.now()/1e3-parseInt(r))>300)return console.log("Timestamp out of range"),!1;let a=`v0:${r}:${t}`,i=n().createHmac("sha256",o).update(a).digest("hex"),u=`v0=${i}`;return n().timingSafeEqual(Buffer.from(u),Buffer.from(s))}let l=async({requestType:e,request:t,rawBody:r})=>{if(!await u({request:t,rawBody:r})||"event_callback"!==e)return new Response("Invalid request",{status:400})},c=(e,t)=>{let r=!0;return async s=>{if(r)try{await i.assistant.threads.setStatus({channel_id:e,thread_ts:t,status:s})}catch(s){let e="object"==typeof s&&null!==s?s:null,t=String(e?.data?.error??e?.message??"");if("missing_scope"===t||"method_not_supported_for_channel_type"===t||t.includes("missing_scope")||t.includes("method_not_supported_for_channel_type")){r=!1,console.warn("Disabling assistant thread status updates",t);return}throw s}}};async function p(e,t,r){let{messages:s}=await i.conversations.replies({channel:e,ts:t,limit:50});if(!s)throw Error("No messages found in thread");return s.map(e=>{let t=!!e.bot_id;if(!e.text)return null;let s=e.text;return!t&&s.includes(`<@${r}>`)&&(s=s.replace(`<@${r}> `,"")),{role:t?"assistant":"user",content:s}}).filter(e=>null!==e)}let d=async()=>{let{user_id:e}=await i.auth.test();if(!e)throw Error("botUserId is undefined");return e}},35847:(e,t,r)=>{"use strict";e.exports=r(30517)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[356,524],()=>r(68503));module.exports=s})();