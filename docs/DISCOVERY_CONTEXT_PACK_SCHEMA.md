# Discovery Context Pack Schema

Defines the JSON contract generated by `lib/agent/discovery/context-pack.ts`. This schema is versioned to guarantee backwards compatibility for downstream agents, snapshot tests, and LangSmith traces.

- **Schema Version:** `1.1.0`
- **Max payload size:** 24 KB per pack (guarded by section-level limits)
- **Generation latency budget:** < 1.2s (in-memory cache enabled by default)

```jsonc
{
  "schemaVersion": "1.1.0",
  "generatedAt": "2025-01-15T04:53:11.002Z",
  "metadata": {
    "caseNumbers": ["SCS0001234"],
    "channelId": "C123456",
    "threadTs": "1700000000.123456",
    "companyName": "Altus Community Healthcare"
  },
  "businessContext": {
    "entityName": "Altus Community Healthcare",
    "entityType": "CLIENT",
    "industry": "Healthcare",
    "aliases": ["Altus", "Altus Health"],
    "technologyPortfolio": "Azure, VMware SD-WAN",
    "serviceDetails": "Altus Health - Azure Environment"
  },
  "caseContext": {
    "caseNumber": "SCS0001234",
    "channelId": "C123456",
    "threadTs": "1700000000.123456",
    "detectedAt": "2025-01-15T03:45:02.000Z",
    "lastUpdated": "2025-01-15T04:52:40.000Z",
    "messageCount": 12
  },
  "slackRecent": {
    "totalMessages": 5,
    "messages": [
      {
        "role": "user",
        "text": "Seeing packet loss at Altus Amarillo North.",
        "timestamp": "1700001234.987600"
      }
    ]
  },
  "similarCases": {
    "total": 2,
    "cases": [
      {
        "caseNumber": "SCS0001010",
        "score": 82,
        "excerpt": "Altus Amarillo North - ISP circuit flapping...",
        "url": "https://mobiz.service-now.com/nav_to.do?...=SCS0001010"
      }
    ]
  },
  "cmdbHits": {
    "total": 2,
    "items": [
      {
        "name": "ALTUS-AMARILLO-FW01",
        "className": "cmdb_ci_cloud_host",
        "ipAddresses": ["10.52.0.4"],
        "environment": "production",
        "ownerGroup": "Network Engineering",
        "matchReason": "IP: 10.52.0.4",
        "relatedItems": [
          {
            "name": "RG-ALTUS-SCUS-PALOALTO-001",
            "className": "cmdb_ci_resource_group",
            "ownerGroup": "Cloud Operations",
            "matchReason": "Related to ALTUS-AMARILLO-FW01"
          }
        ]
      }
    ]
  },
  "policyAlerts": [
    {
      "type": "maintenance_window",
      "severity": "warning",
      "message": "Active change CHG004321 running through 05:00 UTC",
      "details": {
        "changes": [
          {
            "number": "CHG004321",
            "state": "Implement",
            "start": "2025-01-15T03:00:00.000Z",
            "end": "2025-01-15T05:00:00.000Z"
          }
        ]
      },
      "detectedAt": "2025-01-15T04:53:11.002Z"
    }
  ],
  "muscleMemoryExemplars": {
    "total": 2,
    "exemplars": [
      {
        "caseNumber": "SCS0009876",
        "interactionType": "triage",
        "summary": "VPN connectivity issue resolved by updating FortiClient config",
        "qualityScore": 0.92,
        "similarityScore": 0.87,
        "actionTaken": "Escalated to network team, provided diagnostic steps",
        "outcome": "success"
      },
      {
        "caseNumber": "SCS0008765",
        "interactionType": "triage",
        "summary": "Azure VPN tunnel down, reset VPN gateway connections",
        "qualityScore": 0.89,
        "similarityScore": 0.82,
        "actionTaken": "KB article KB0012345 shared, gateway reset initiated",
        "outcome": "success"
      }
    ]
  }
}
```

## Field Reference

| Field | Type | Required | Notes |
| --- | --- | --- | --- |
| `schemaVersion` | `string` | ✅ | Semantic version of the schema. Consumers must branch by this value. |
| `generatedAt` | `ISO string` | ✅ | UTC timestamp when the pack was built. |
| `metadata.caseNumbers` | `string[]` | ✅ | Primary ServiceNow case numbers referenced in the pack. |
| `metadata.channelId` | `string` | ❌ | Slack channel id (if known). |
| `metadata.threadTs` | `string` | ❌ | Slack thread timestamp. |
| `metadata.companyName` | `string` | ❌ | Canonical customer name resolved by Business Context service. |
| `businessContext` | `DiscoveryBusinessContextSummary` | ❌ | High-level client information (entity name, aliases, service notes). |
| `caseContext` | `CaseContextSummary` | ❌ | Slack thread metadata from `ContextManager`. |
| `slackRecent` | Summary block | ❌ | At most `discoverySlackMessageLimit` messages (default 5, each truncated to 280 chars). |
| `similarCases` | Summary block | ❌ | Up to `discoverySimilarCasesTopK` entries with score, excerpt, and URL. |
| `cmdbHits` | Summary block | ❌ | Max 5 matches. Each match may include up to 3 `relatedItems`. |
| `policyAlerts` | `PolicySignal[]` | ❌ | Ordered by severity (critical → warning → info). Empty array when no signals. |
| `muscleMemoryExemplars` | Summary block | ❌ | **v1.1.0+** Semantic search results from past high-quality interactions. Max 3 exemplars (controlled by `MUSCLE_MEMORY_TOP_K`). |

### CMDB Related Items

For each matched CI we fetch related CIs (parent/child relationships via `cmdb_rel_ci`) for additional blast-radius hints.

- Limited to 3 base CIs and 3 related items per base to preserve size guarantees.
- `matchReason` for related entries is the contextual string `Related to <base CI>`.
- Related items inherit the same fields as the base summary (`name`, `className`, `ownerGroup`, etc).

### Policy Alerts

- Includes SLA breaches, SLA approaching, after-hours, high-risk/VIP flags, and **active maintenance windows**.
- Maintenance window detection queries `change_request` for active windows tied to the case's company (or company name when sys_id is unavailable).
- Each maintenance alert lists visible change numbers, state, and UTC window.

### Muscle Memory Exemplars (v1.1.0+)

- Semantic search results from the muscle memory store (Neon + pgvector).
- Contains past high-quality agent interactions similar to the current case context.
- Each exemplar includes:
  - `caseNumber`: Original case where this interaction occurred
  - `interactionType`: Type of interaction (`triage`, `kb_generation`, `escalation`, etc.)
  - `summary`: Brief description of what happened (extracted from context for embedding)
  - `qualityScore`: 0.0-1.0 score based on supervisor approval, human feedback, and outcome
  - `similarityScore`: 0.0-1.0 cosine similarity to current case (optional)
  - `actionTaken`: What the agent did (work notes, escalations, KB articles, etc.)
  - `outcome`: Result (`success`, `partial_success`, `failure`, `user_corrected`)
- **Config controls:**
  - `MUSCLE_MEMORY_RETRIEVAL_ENABLED`: Toggle retrieval (default: `false`)
  - `MUSCLE_MEMORY_TOP_K`: Max exemplars to return (default: `3`)
  - `MUSCLE_MEMORY_MIN_QUALITY`: Minimum quality threshold (default: `0.7`)
- **Size budget:** ~600 bytes (3 exemplars × 200 chars avg)
- **Graceful degradation:** If retrieval fails or is disabled, this field is omitted entirely

## Size & Rate Limits

- Slack preview: last `N` user/bot messages, truncated to 280 chars each.
- Similar cases: excerpts trimmed to 280 chars, `topK` configurable via `DISCOVERY_SIMILAR_CASES_TOP_K`.
- CMDB hits: 5 direct matches max, 3 related per match.
- Muscle memory: Max 3 exemplars, each ~200 chars (controlled by `MUSCLE_MEMORY_TOP_K`).
- Cache TTL: 15 minutes (`DISCOVERY_CONTEXT_CACHE_TTL_MINUTES`), size 100 entries.

## Versioning

- Increment the **minor** version when adding optional fields.
- Increment the **major** version when removing or retyping existing fields.
- Downstream consumers should gate on `schemaVersion` before relying on new sections.
